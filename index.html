<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JM Autogas | V23 Motion</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-body: #050505; --bg-panel: #111111; --bg-input: #1a1a1a; --bg-hover: #222222;
            --primary: #00e676; --primary-dim: rgba(0, 230, 118, 0.2);
            --text-main: #ffffff; --text-sec: #888888; --border: #333333;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.2); --shadow-lg: 0 20px 60px rgba(0,0,0,0.5);
            --st-online: #00e676; --st-fetch: #ffea00; --st-recv: #2979ff; --st-off: #757575; --st-err: #ff1744;
            --glass-bg: rgba(17, 17, 17, 0.95); --glass-blur: blur(12px);
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1); /* Curva de animación premium */
        }
        body.light-mode {
            --bg-body: #f5f5f7; --bg-panel: #ffffff; --bg-input: #eef0f2; --bg-hover: #e0e0e0;
            --text-main: #1d1d1f; --text-sec: #6e6e73; --border: #d2d2d7; --primary: #00a854;
            --primary-dim: rgba(0, 168, 84, 0.15); --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-lg: 0 15px 40px rgba(0,0,0,0.1); --glass-bg: rgba(255, 255, 255, 0.95);
        }
        body.abastible-mode { --primary: #ff6d00; --primary-dim: rgba(255, 109, 0, 0.2); }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg-body); color: var(--text-main); height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        /* --- LOGIN VANGUARDISTA --- */
        #login-scr { 
            position: fixed; inset: 0; z-index: 5000; 
            background: #000; /* Fondo solido inicial */
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.8s var(--ease-out-expo), transform 0.8s var(--ease-out-expo);
        }
        
        /* Estado de salida del login (Zoom Out + Fade) */
        #login-scr.login-exit {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        .lg-card { 
            background: linear-gradient(145deg, #151515, #000); 
            padding: 40px 30px; border-radius: 24px; border: 1px solid #333; 
            width: 90%; max-width: 360px; text-align: center; 
            box-shadow: 0 20px 80px rgba(0,0,0,0.9); 
            position: relative; overflow: hidden;
            transition: transform 0.3s;
        }
        
        .lg-icon { font-size: 3rem; color: var(--primary); margin-bottom: 10px; filter: drop-shadow(0 0 15px var(--primary-dim)); }
        
        .lg-inp { 
            width: 100%; padding: 16px; margin-bottom: 12px; background: rgba(255,255,255,0.03); 
            border: 1px solid var(--border); border-radius: 12px; color: #fff; font-size: 1.1rem; text-align: center; 
            transition: 0.3s; 
        }
        .lg-inp:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); box-shadow: 0 0 15px var(--primary-dim); }
        .lg-inp::placeholder { color: #444; }

        .btn-lg { 
            width: 100%; padding: 16px; background: var(--primary); color: #000; font-weight: 800; border: none; 
            border-radius: 12px; cursor: pointer; font-size: 1rem; margin-top: 15px; transition: 0.2s;
            box-shadow: 0 0 20px var(--primary-dim);
        }
        .btn-lg:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-lg:active { transform: scale(0.98); }

        /* MENSAJE DE ESTADO LOGIN (Debajo de los inputs) */
        #lg-status-area {
            min-height: 25px; margin-top: 15px; font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            opacity: 0; transform: translateY(5px); transition: all 0.3s;
        }
        #lg-status-area.visible { opacity: 1; transform: translateY(0); }
        
        .st-error { color: var(--st-err); }
        .st-success { color: var(--st-online); }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* --- APP CONTENT TRANSITION --- */
        /* Inicialmente oculto y desplazado */
        header, .toolbar, main, .footer, .fab {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s 0.2s var(--ease-out-expo), transform 0.8s 0.2s var(--ease-out-expo); /* Delay para que espere al login */
        }
        /* Clase para activar la interfaz */
        body.app-ready header, 
        body.app-ready .toolbar, 
        body.app-ready main, 
        body.app-ready .footer, 
        body.app-ready .fab {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- RESTO DE LA UI (V22) --- */
        header { height: 60px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; z-index: 20; box-shadow: var(--shadow-sm); }
        .h-left { display: flex; align-items: center; gap: 15px; }
        
        .status-pill { display: flex; align-items: center; gap: 6px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; background: var(--bg-input); padding: 4px 10px; border-radius: 50px; border: 1px solid var(--border); }
        .dot { width: 6px; height: 6px; border-radius: 50%; }
        .st-online .dot { background: var(--st-online); box-shadow: 0 0 5px var(--st-online); }
        .st-fetch .dot { background: var(--st-fetch); animation: pulse 1s infinite; }
        .st-recv .dot { background: var(--st-recv); animation: blink 0.5s infinite; }
        .st-off .dot { background: var(--st-off); }
        .st-err .dot { background: var(--st-err); }
        @keyframes pulse { 0%{opacity:1} 50%{opacity:0.3} 100%{opacity:1} } @keyframes blink { 0%{opacity:1} 50%{opacity:0.5} 100%{opacity:1} }

        .h-right { display: flex; align-items: center; gap: 8px; }
        .icon-btn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid transparent; display: grid; place-items: center; color: var(--text-sec); cursor: pointer; transition: 0.2s; }
        .icon-btn:hover { background: var(--bg-input); color: var(--text-main); border-color: var(--border); }
        .btn-danger:hover { color: var(--st-err); border-color: rgba(255, 23, 68, 0.3); }

        .toolbar { padding: 12px 20px; background: var(--bg-body); border-bottom: 1px solid var(--border); display: grid; grid-template-columns: auto 1fr; gap: 15px; align-items: center; flex-shrink: 0; z-index: 10; }
        .toolbar-left { display: flex; gap: 10px; flex-wrap: nowrap; align-items: center; }
        .grp { background: var(--bg-panel); border-radius: 8px; padding: 3px; display: flex; border: 1px solid var(--border); height: 38px; align-items: center; }
        .btn-cap { background: transparent; border: none; padding: 0 14px; height: 30px; border-radius: 6px; color: var(--text-sec); font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .btn-cap.active { background: var(--primary); color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .abast-logo { height: 14px; filter: grayscale(1) brightness(2); } .btn-cap.active .abast-logo { filter: brightness(0); }
        body.light-mode .btn-cap.active .abast-logo { filter: brightness(0); }
        .search-bar { display: flex; align-items: center; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 0 12px; height: 38px; width: 100%; transition: 0.3s; }
        .search-bar:focus-within { border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary); }
        .search-bar input { background: transparent; border: none; color: var(--text-main); flex: 1; margin-left: 10px; height: 100%; font-size: 0.9rem; }

        .loader-line { position: fixed; top: 0; left: 0; height: 3px; width: 100%; background: transparent; z-index: 9999; overflow: hidden; display: none; }
        .loader-bar { width: 100%; height: 100%; background: var(--primary); transform: translateX(-100%); animation: load 1.5s infinite; }
        @keyframes load { 0% {transform: translateX(-100%)} 100% {transform: translateX(100%)} }

        main { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding: 0 20px; position: relative; -webkit-overflow-scrolling: touch; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-row { animation: fadeInUp 0.3s ease-out forwards; opacity: 0; }

        #v-pc { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; margin-bottom: 20px; }
        #v-pc th { text-align: left; padding: 16px 12px; color: var(--text-sec); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--bg-body); z-index: 5; cursor: pointer; user-select: none; transition: 0.2s; }
        #v-pc th:hover { color: var(--text-main); background: var(--bg-input); }
        #v-pc th.active-sort { color: var(--primary); border-bottom-color: var(--primary); }
        .sort-icon { margin-left: 5px; font-size: 0.8em; }
        #v-pc td { padding: 14px 12px; border-bottom: 1px solid var(--bg-input); font-size: 0.9rem; color: var(--text-main); vertical-align: middle; }
        #v-pc tr:hover td { background: var(--bg-hover); color: var(--primary); cursor: pointer; }
        .td-diag { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-sec); }
        .pc-only { display: none; }
        @media (min-width: 1024px) { .pc-only { display: table; } .mob-only { display: none !important; } }

        .mob-only { display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px; margin-top: 15px; }
        .m-card { background: var(--bg-panel); padding: 15px; border-radius: 10px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
        .m-head { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 8px; }
        .m-pat { color: var(--primary); font-weight: 800; font-family: monospace; font-size: 1.1rem; }
        .coord-tag { display: inline-flex; align-items: center; gap: 5px; background: rgba(0, 230, 118, 0.1); color: var(--primary); font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(0, 230, 118, 0.2); margin-top: 5px; }

        .footer { height: 50px; background: var(--bg-panel); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; flex-shrink: 0; z-index: 20; font-size: 0.85rem; color: var(--text-sec); }
        .pg-btn { width: 32px; height: 32px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; cursor: pointer; display: grid; place-items: center; transition: 0.2s; }
        .pg-btn:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); }
        .pg-btn:disabled { opacity: 0.3; cursor: default; }

        .fab { position: fixed; bottom: 70px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: var(--primary); color: #000; display: grid; place-items: center; font-size: 1.5rem; box-shadow: 0 5px 20px var(--primary-dim); cursor: pointer; z-index: 100; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1); }

        @media (max-width: 900px) {
            .toolbar { grid-template-columns: 1fr; align-items: stretch; height: auto; gap: 10px; }
            .toolbar-left { justify-content: space-between; width: 100%; overflow-x: auto; padding-bottom: 2px; }
            .grp { flex-shrink: 0; } 
        }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .m-box { background: var(--glass-bg); backdrop-filter: var(--glass-blur); width: 95%; max-width: 750px; max-height: 90vh; border-radius: 16px; border: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: var(--shadow-lg); }
        .m-head { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .m-body-form { padding: 20px; overflow-y: auto; }
        .form-section { margin-bottom: 20px; }
        .form-sec-title { font-size: 0.8rem; font-weight: 700; color: var(--text-sec); text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .inp-grp { display: flex; flex-direction: column; }
        .inp-lbl { font-size: 0.7rem; color: var(--text-sec); font-weight: 600; margin-bottom: 6px; }
        .inp { width: 100%; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); border-radius: 8px; transition: 0.2s; }
        .inp:focus { border-color: var(--primary); background: var(--bg-body); box-shadow: 0 0 0 2px var(--primary-dim); }
        textarea.inp { resize: vertical; }
        .m-foot { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: var(--bg-panel); border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; }
        .btn-act { flex: 1; padding: 12px; background: var(--primary); color: #000; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .btn-act:active { transform: scale(0.98); }
        .btn-del { background: transparent; border: 1px solid #ff4444; color: #ff4444; width: 50px; display: none; border-radius: 8px; cursor: pointer; }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; gap: 10px; } }

        .cfg-list-item, .usr-list-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border); align-items: center; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="login-scr">
        <div class="lg-card" id="lg-card">
            <i class="fas fa-fingerprint lg-icon"></i>
            <h2 style="color:#fff; margin:0 0 5px 0;">Bienvenido</h2>
            <p style="color:var(--text-sec); margin-bottom:30px; font-size:0.9rem">Sistema Seguro de Gestión</p>
            
            <input type="text" id="lg-u" class="lg-inp" placeholder="Usuario" autocomplete="off">
            <input type="tel" id="lg-p" class="lg-inp" placeholder="PIN (Solo Números)" inputmode="numeric" pattern="[0-9]*" maxlength="8" style="-webkit-text-security: disc;">
            
            <div id="lg-status-area"></div>

            <button class="btn-lg" onclick="login()">ACCEDER AHORA</button>
        </div>
    </div>

    <div class="loader-line" id="loader"><div class="loader-bar"></div></div>

    <header>
        <div class="h-left">
            <div class="status-pill st-off" id="s-pill"><div class="dot"></div><span id="s-txt">Offline</span></div>
        </div>
        <div class="h-right">
            <span id="u-name" style="font-size:0.85rem; margin-right:10px; font-weight:600">...</span>
            <div class="icon-btn" onclick="document.body.classList.toggle('light-mode')" title="Tema"><i class="fas fa-adjust"></i></div>
            <div class="icon-btn" onclick="openCfg()" title="Configuración"><i class="fas fa-cog"></i></div>
            <div class="icon-btn" id="btn-adm" style="display:none; color:var(--primary); border-color:var(--primary-dim)" onclick="openAdm()" title="Usuarios"><i class="fas fa-users-cog"></i></div>
            <div class="icon-btn btn-danger" onclick="location.reload()" title="Salir"><i class="fas fa-power-off"></i></div>
        </div>
    </header>

    <div class="toolbar">
        <div class="toolbar-left">
            <div class="grp">
                <button class="btn-cap active" onclick="setCat('TALLER', this)">TALLER</button>
                <button class="btn-cap" onclick="setCat('ABASTIBLE', this)">
                    <img src="https://storage.googleapis.com/web-abastible-prod/2025/03/Logo_Abastible.png" class="abast-logo">
                </button>
            </div>
            <div class="grp">
                <button class="btn-cap active" onclick="setYear('2026', this)">2026</button>
                <button class="btn-cap" onclick="setYear('2025', this)">2025</button>
                <button class="btn-cap" onclick="setYear('2024', this)">2024</button>
            </div>
        </div>
        <div class="search-bar">
            <i class="fas fa-search" style="color:var(--text-sec)"></i>
            <input type="text" placeholder="Buscar patente, cliente, rut..." onkeyup="doSearch(this.value)">
        </div>
    </div>

    <main>
        <table id="v-pc" class="pc-only">
            <thead>
                <tr>
                    <th onclick="setSort(0)">Fecha <i class="fas sort-icon" id="si-0"></i></th>
                    <th onclick="setSort(1)">Sede <i class="fas sort-icon" id="si-1"></i></th>
                    <th onclick="setSort(2)">Ficha <i class="fas sort-icon" id="si-2"></i></th>
                    <th onclick="setSort(3)">Cliente <i class="fas sort-icon" id="si-3"></i></th>
                    <th onclick="setSort(9)">Patente <i class="fas sort-icon" id="si-9"></i></th>
                    <th>Vehículo</th>
                    <th>Coord.</th>
                    <th>Diagnóstico</th>
                </tr>
            </thead>
            <tbody id="tb-pc"></tbody>
        </table>
        <div id="v-mob" class="mob-only"></div>
    </main>

    <div class="footer">
        <span id="pg-info">Cargando...</span>
        <div style="display:flex; gap:10px">
            <button class="pg-btn" id="bp" onclick="mv(-1)"><i class="fas fa-chevron-left"></i></button>
            <button class="pg-btn" id="bn" onclick="mv(1)"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <div class="fab" id="fab" onclick="form()"><i class="fas fa-plus"></i></div>

    <div class="modal" id="m-form">
        <div class="m-box">
            <div class="m-head">
                <h3 style="margin:0; color:var(--primary)" id="f-ttl">Registro</h3>
                <i class="fas fa-times" onclick="closeM('m-form')" style="cursor:pointer; font-size:1.2rem; color:var(--text-sec)"></i>
            </div>
            <div class="m-body-form">
                <input type="hidden" id="f-id">
                <div class="form-section">
                    <div class="form-sec-title">Datos</div>
                    <div class="form-grid">
                        <div class="inp-grp"><span class="inp-lbl">FECHA *</span><input type="date" id="i_fec" class="inp"></div>
                        <div class="inp-grp"><span class="inp-lbl">SEDE *</span><select id="i_sede" class="inp"></select></div>
                        <div class="inp-grp"><span class="inp-lbl">FICHA</span><input type="text" id="i_fic" class="inp"></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-sec-title">Vehículo</div>
                    <div class="form-grid">
                        <div class="inp-grp"><span class="inp-lbl">PATENTE *</span><input type="text" id="i_pat" class="inp" style="border-color:var(--primary); font-weight:700"></div>
                        <div class="inp-grp" style="grid-column: span 2"><span class="inp-lbl">CLIENTE</span><input type="text" id="i_cli" class="inp"></div>
                        <div class="inp-grp"><span class="inp-lbl">RUT</span><input type="text" id="i_rut" class="inp"></div>
                        <div class="inp-grp"><span class="inp-lbl">CELULAR</span><input type="text" id="i_cel" class="inp"></div>
                        <div class="inp-grp"><span class="inp-lbl">MARCA</span><input type="text" id="i_mar" class="inp"></div>
                        <div class="inp-grp"><span class="inp-lbl">MODELO</span><input type="text" id="i_mod" class="inp"></div>
                        <div class="inp-grp"><span class="inp-lbl">AÑO</span><input type="number" id="i_ano" class="inp"></div>
                    </div>
                </div>
                <div class="form-section" style="margin-bottom:0">
                    <div class="form-sec-title">Detalle</div>
                    <div class="form-grid">
                        <div class="inp-grp"><span class="inp-lbl">TÉCNICO *</span><select id="i_tec" class="inp"></select></div>
                        <div class="inp-grp"><span class="inp-lbl">KM</span><input type="text" id="i_km" class="inp"></div>
                        <div class="inp-grp"><span class="inp-lbl">COLOR</span><input type="text" id="i_col" class="inp"></div>
                        <div class="inp-grp" style="grid-column: span 3"><span class="inp-lbl">DIAGNÓSTICO</span><textarea id="i_dia" class="inp" rows="3"></textarea></div>
                        <div class="inp-grp" style="grid-column: span 3"><span class="inp-lbl">MATERIALES</span><input type="text" id="i_mat" class="inp"></div>
                        <div class="inp-grp"><span class="inp-lbl">COORDENADAS</span><input type="text" id="i_coo" class="inp"></div>
                        <div class="inp-grp" style="grid-column: span 2"><span class="inp-lbl">COMUNA</span><input type="text" id="i_com" class="inp"></div>
                    </div>
                </div>
            </div>
            <div class="m-foot">
                <button class="btn-act" id="btn-s" onclick="save()">GUARDAR REGISTRO</button>
                <button class="btn-del" id="btn-d" onclick="del()"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </div>

    <div class="modal" id="m-cfg">
        <div class="m-box" style="max-width:450px">
            <div class="m-head"><h3 style="margin:0">Configuración</h3><i class="fas fa-times" onclick="closeM('m-cfg')" style="cursor:pointer"></i></div>
            <div style="padding:20px">
                <div style="display:flex; gap:10px; margin-bottom:15px">
                    <select id="c-cat" class="inp" style="flex:1"><option value="SEDE">SEDE</option><option value="TECNICO">TECNICO</option></select>
                    <input type="text" id="c-val" class="inp" placeholder="Nuevo valor..." style="flex:2">
                    <button class="btn-act" style="width:60px" onclick="addCfg()">+</button>
                </div>
                <div id="cfg-list" style="max-height:250px; overflow:auto; border:1px solid var(--border); border-radius:8px; background:var(--bg-input)"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="m-usr">
        <div class="m-box" style="max-width:450px">
            <div class="m-head"><h3 style="margin:0">Usuarios</h3><i class="fas fa-times" onclick="closeM('m-usr')" style="cursor:pointer"></i></div>
            <div style="padding:20px">
                <div style="background:var(--bg-input); padding:15px; border-radius:12px; border:1px solid var(--border); margin-bottom:15px">
                    <input type="text" id="u-new" class="inp" placeholder="Usuario" style="margin-bottom:10px">
                    <input type="text" id="p-new" class="inp" placeholder="Clave (Numérica)" style="margin-bottom:10px">
                    <label style="font-size:0.85rem; color:var(--primary); font-weight:600; display:flex; align-items:center; gap:5px">
                        <input type="checkbox" id="adm-chk" style="accent-color:var(--primary)"> ADMIN TOTAL
                    </label>
                    <button class="btn-act" style="margin-top:15px; width:100%" onclick="addUsr()">Crear Usuario</button>
                </div>
                <div id="usr-list" style="border:1px solid var(--border); border-radius:8px; overflow:hidden"></div>
            </div>
        </div>
    </div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxWikUL6ErRmzZJNWVikLp2g3AtwL0QCM8DXkJuTZ6baBGUYGm8wwKt98lGoycdwty6/exec";
    let S = { 
        cat:'TALLER', year:'2026', page:1, data:[], user:null, lists:[], users:[], q:'', timer:null,
        sort: { col: null, asc: false }
    };

    function st(c) {
        let p=document.getElementById('s-pill'), t=document.getElementById('s-txt');
        p.className = `status-pill st-${c}`;
        t.innerText = c==='online'?'Online':(c==='fetch'?'Obteniendo':(c==='recv'?'Recibiendo':(c==='err'?'Error':'Offline')));
    }
    function ld(b) { document.getElementById('loader').style.display = b?'block':'none'; }
    function closeM(id){ document.getElementById(id).style.display='none'; }

    // SEGURIDAD: NUMEROS EN PASSWORD
    document.getElementById('lg-p').addEventListener('input', function (e) {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    // HELPERS LOGIN UI
    function showLgMsg(type, txt) {
        let box = document.getElementById('lg-status-area');
        box.innerHTML = type === 'err' ? `<i class="fas fa-exclamation-circle"></i> ${txt}` : `<i class="fas fa-check-circle"></i> ${txt}`;
        box.className = type === 'err' ? 'st-error visible shake' : 'st-success visible';
        if(type === 'err') setTimeout(() => box.classList.remove('shake'), 500);
    }

    async function apiCall(params, body = null) {
        st('fetch'); ld(true);
        try {
            let url = new URL(API_URL);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            let opts = body ? { method: 'POST', body: body, mode: 'no-cors' } : {};
            let r = await fetch(url, opts);
            st('recv');
            if (body && r.type === 'opaque') return { status: 'ok' };
            return await r.json();
        } catch (e) {
            console.error(e); st('off'); throw e;
        } finally { ld(false); }
    }

    async function login() {
        let u_in=document.getElementById('lg-u').value, p_in=document.getElementById('lg-p').value;
        if(!u_in || !p_in) return showLgMsg('err', 'Faltan datos');
        
        // Estado visual de carga
        showLgMsg('norm', 'Verificando...'); 
        
        try {
            let [j_usr, j_cfg] = await Promise.all([apiCall({type:'users'}), apiCall({type:'config'})]);
            S.users=j_usr.data; S.lists=j_cfg.data;
            let f = S.users.find(x => x.user.toLowerCase() === u_in.toLowerCase() && x.pass == p_in);
            
            if(f){
                // EXITO: ANIMACIÓN DE SALIDA
                showLgMsg('ok', 'Acceso Autorizado');
                S.user=f;
                
                setTimeout(() => {
                    // 1. Zoom Out y Fade del Login
                    document.getElementById('login-scr').classList.add('login-exit');
                    // 2. Activar transición de entrada del contenido
                    document.body.classList.add('app-ready');
                    
                    // 3. Remover login del DOM después de la animación
                    setTimeout(() => {
                        document.getElementById('login-scr').style.display='none';
                        // Iniciar UI
                        document.getElementById('u-name').innerText = f.user;
                        if(f.perms==='ALL') document.getElementById('btn-adm').style.display='grid';
                        if(!f.perms.includes('ADD') && f.perms!=='ALL') document.getElementById('fab').style.display='none';
                        st('online'); load();
                    }, 800);
                }, 600); // Pequeña pausa para leer el mensaje de éxito

            } else { 
                st('online'); showLgMsg('err', 'Credenciales incorrectas'); 
            }
        } catch(e){ showLgMsg('err', 'Error de conexión'); }
    }

    function setCat(c,b){ S.cat=c; document.body.classList.toggle('abastible-mode', c==='ABASTIBLE'); upd(b,0); S.page=1; load(); }
    function setYear(y,b){ S.year=y; upd(b,1); S.page=1; load(); }
    function upd(b,g){ document.querySelectorAll('.grp')[g].querySelectorAll('.btn-cap').forEach(e=>e.classList.remove('active')); b.classList.add('active'); }

    function setSort(col) {
        if (S.sort.col === col) S.sort.asc = !S.sort.asc;
        else { S.sort.col = col; S.sort.asc = true; }
        updateSortIcons(); S.page = 1; load();
    }

    function updateSortIcons() {
        document.querySelectorAll('.sort-icon').forEach(i => i.className = 'fas sort-icon');
        document.querySelectorAll('#v-pc th').forEach(th => th.classList.remove('active-sort'));
        if (S.sort.col !== null) {
            let th = document.querySelectorAll('#v-pc th')[getIndexMap(S.sort.col)];
            if(th) {
                th.classList.add('active-sort');
                let icon = th.querySelector('.sort-icon');
                if(icon) icon.className = `fas sort-icon fa-sort-${S.sort.asc ? 'up' : 'down'}`;
            }
        }
    }
    function getIndexMap(col) {
        if(col===0) return 0; if(col===1) return 1; if(col===2) return 2; if(col===3) return 3; if(col===9) return 4; return -1; 
    }

    async function load() {
        document.getElementById('tb-pc').style.opacity = '0.5';
        try {
            let params = { sheetName: (S.cat==='TALLER'?'Folios ':'ABASTIBLE ')+S.year, page: S.page };
            if(S.q) params.search = S.q;
            if(S.sort.col !== null) { params.sortCol = S.sort.col; params.sortAsc = S.sort.asc; }
            let j = await apiCall(params);
            S.data=j.data; render(); st('online');
        } catch(e){}
        document.getElementById('tb-pc').style.opacity = '1';
    }

    function render() {
        let pc=document.getElementById('tb-pc'), mob=document.getElementById('v-mob');
        pc.innerHTML=''; mob.innerHTML='';
        if(S.data.length===0) { mob.innerHTML='<div style="text-align:center;color:var(--text-sec);padding:30px">Sin resultados</div>'; return; }
        
        S.data.forEach((r, i)=>{
            let d=r[0]; if(d&&d.includes('T')) d=d.split('T')[0];
            let delay = `animation-delay: ${i * 0.02}s`;
            
            // PC
            let tr=document.createElement('tr'); tr.className='animate-row'; tr.style=delay;
            tr.innerHTML=`<td>${d}</td><td>${r[1]}</td><td>${r[2]}</td><td style="font-weight:600">${r[3]}</td><td style="color:var(--primary);font-family:monospace;font-weight:700">${r[9]}</td><td>${r[7]} ${r[8]}</td><td style="color:var(--text-sec);font-size:0.85rem">${r[13]||'-'}</td><td class="td-diag" title="${r[14]}">${r[14]||'-'}</td>`;
            tr.onclick=()=>form(r); pc.appendChild(tr);

            // MOBILE
            let c=document.createElement('div'); c.className='m-card animate-row'; c.style=delay;
            let coordHtml = r[13] ? `<div class="coord-tag"><i class="fas fa-map-marker-alt"></i> ${r[13]}</div>` : '';
            c.innerHTML=`<div class="m-head"><span class="m-pat">${r[9]||'S/P'}</span><small>${d}</small></div><div style="font-weight:600;margin-bottom:5px">${r[3]}</div><div style="font-size:0.85rem;color:var(--text-sec)">${r[14]||'-'}</div>${coordHtml}`;
            c.onclick=()=>form(r); mob.appendChild(c);
        });
        document.getElementById('pg-info').innerText=`Página ${S.page}`;
        document.getElementById('bp').disabled=S.page===1; document.getElementById('bn').disabled=S.data.length<25;
        document.querySelector('main').scrollTo({top:0, behavior:'smooth'});
    }

    function doSearch(v){ clearTimeout(S.timer); S.timer=setTimeout(()=>{ S.q=v; S.page=1; load(); },600); }
    function mv(d){ S.page+=d; load(); }

    const MAP=['i_fec','i_sede','i_fic','i_cli','i_rut','i_cel','i_com','i_mar','i_mod','i_pat','i_col','i_km','i_ano','i_coo','i_dia','i_tec','i_mat'];
    function form(d=null){
        let isEd=!!d; document.getElementById('f-ttl').innerText=isEd?'Editar Folio':'Nuevo Folio';
        document.getElementById('f-id').value=isEd?d[d.length-1]:'';
        document.getElementById('btn-d').style.display=isEd&&(S.user.perms==='ALL'||S.user.perms.includes('DEL'))?'block':'none';
        
        let fill = (id, cat) => {
            let opts = S.lists.filter(x=>x.cat===cat).map(x=>`<option>${x.val}</option>`).join('');
            document.getElementById(id).innerHTML = opts || '<option>Sin opciones</option>';
        };
        fill('i_sede','SEDE'); fill('i_tec','TECNICO');

        MAP.forEach((id,i)=>{ let v=isEd?d[i]:''; if(i===0&&v&&v.includes('T'))v=v.split('T')[0]; document.getElementById(id).value=v; });
        if(!isEd)document.getElementById('i_fec').valueAsDate=new Date();
        document.getElementById('m-form').style.display='flex';
    }

    async function save(){
        if(!document.getElementById('i_fec').value || !document.getElementById('i_pat').value) return alert("Fecha y Patente obligatorios");
        let b=document.getElementById('btn-s'); b.disabled=true; b.innerText="Guardando...";
        let id=document.getElementById('f-id').value;
        let p=new URLSearchParams();
        p.append('sheetName',(S.cat==='TALLER'?'Folios ':'ABASTIBLE ')+S.year);
        p.append('action',id?'UPDATE':'CREATE'); if(id)p.append('rowId',id);
        MAP.forEach((id,i)=>{
            let k=['ly','sede','ficha','cliente','rut','celular','comuna','marca','modelo','patente','color','km','fabricacion','coord','diag','colab','mat'];
            p.append(k[i], document.getElementById(id).value.toUpperCase());
        });
        await apiCall({}, p); closeM('m-form'); load(); b.disabled=false; b.innerText="GUARDAR REGISTRO";
    }
    async function del(){ if(confirm("¿Eliminar este registro permanentemente?")){ await apiCall({}, new URLSearchParams({sheetName:(S.cat==='TALLER'?'Folios ':'ABASTIBLE ')+S.year, action:'DELETE', rowId:document.getElementById('f-id').value})); closeM('m-form'); load(); }}

    function openCfg(){
        document.getElementById('cfg-list').innerHTML=S.lists.map(x=>`<div class="cfg-list-item"><span><b>${x.cat}</b>: ${x.val}</span><i class="fas fa-trash" style="color:var(--st-err);cursor:pointer;opacity:0.7" onclick="delCfg(${x.id})"></i></div>`).join('');
        document.getElementById('m-cfg').style.display='flex';
    }
    async function addCfg(){ let c=document.getElementById('c-cat').value, v=document.getElementById('c-val').value; if(!v)return; await apiCall({},new URLSearchParams({type:'config',action:'ADD',cat:c,val:v})); location.reload(); }
    async function delCfg(id){ if(!confirm("Eliminar?"))return; await apiCall({},new URLSearchParams({type:'config',action:'DEL',rowId:id})); location.reload(); }

    function openAdm(){
        document.getElementById('usr-list').innerHTML=S.users.map(u=>`<div class="usr-list-item"><div><b style="color:var(--primary)">${u.user}</b> <small style="color:var(--text-sec)">[${u.perms}]</small></div>${u.user!=='Jimmy'?`<i class="fas fa-trash" style="color:var(--st-err);cursor:pointer;opacity:0.7" onclick="delUsr(${u.id})"></i>`:''}</div>`).join('');
        document.getElementById('m-usr').style.display='flex';
    }
    async function addUsr(){ let u=document.getElementById('u-new').value, p=document.getElementById('p-new').value; if(!u||!p)return; let perm=document.getElementById('adm-chk').checked?'ALL':'ADD,EDIT'; await apiCall({},new URLSearchParams({type:'users',action:'CREATE',u_user:u,u_pass:p,u_perms:perm})); location.reload(); }
    async function delUsr(id){ if(confirm("Eliminar usuario?")){ await apiCall({},new URLSearchParams({type:'users',action:'DELETE',rowId:id})); location.reload(); }}
</script>
</body>
</html>
