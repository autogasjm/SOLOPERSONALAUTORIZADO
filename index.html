<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JM Autogas | V31.3 Fix Visuals</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* CORE & VARIABLES (iOS GLASSMORPHISM) */
        :root {
            --bg-body: #050507; 
            --bg-panel: rgba(22, 22, 24, 0.65);
            --bg-input: rgba(255, 255, 255, 0.05);
            --bg-hover: rgba(255, 255, 255, 0.1);
            --primary: #00e676;
            --primary-dim: rgba(0, 230, 118, 0.25);
            --text-main: #ffffff;
            --text-sec: #a1a1aa;
            --border: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.05);
            --shadow-sm: 0 4px 15px rgba(0,0,0,0.2);
            --shadow-lg: 0 25px 50px rgba(0,0,0,0.6);
            --glass-blur: blur(24px) saturate(180%);
            --st-online: #00e676; --st-fetch: #ffea00; --st-recv: #2979ff; --st-off: #757575; --st-err: #ff1744;
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --spring: cubic-bezier(0.175, 0.885, 0.32, 1.1);
        }
        body.light-mode {
            --bg-body: #f2f2f7; 
            --bg-panel: rgba(255, 255, 255, 0.75);
            --bg-input: rgba(0, 0, 0, 0.04);
            --bg-hover: rgba(0, 0, 0, 0.08);
            --text-main: #1d1d1f;
            --text-sec: #86868b;
            --border: rgba(0, 0, 0, 0.1);
            --border-light: rgba(255, 255, 255, 0.5);
            --shadow-sm: 0 4px 15px rgba(0,0,0,0.05);
            --shadow-lg: 0 25px 50px rgba(0,0,0,0.12);
        }
        body.abastible-mode { --primary: #ff6d00; --primary-dim: rgba(255, 109, 0, 0.25); }
        
        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; background-color: var(--bg-body); color: var(--text-main); height: 100dvh; overflow: hidden; 
            display: flex; flex-direction: column; transition: background-color 0.5s ease, color 0.5s ease;
            position: relative;
        }

        body::before, body::after {
            content: ''; position: absolute; border-radius: 50%; filter: blur(100px); pointer-events: none; z-index: 0; transition: background 0.8s ease;
        }
        body::before { width: 50vw; height: 50vw; background: rgba(0, 230, 118, 0.12); top: -15vw; left: -10vw; }
        body::after { width: 40vw; height: 40vw; background: rgba(41, 121, 255, 0.08); bottom: 10vw; right: -10vw; }
        body.light-mode::before { background: rgba(0, 168, 84, 0.15); }
        body.light-mode::after { background: rgba(41, 121, 255, 0.1); }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(150, 150, 150, 0.3); border-radius: 10px; border: 2px solid transparent; background-clip: padding-box; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(150, 150, 150, 0.5); }

        header, .toolbar, main, .footer { position: relative; z-index: 10; }

        @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scalePop { from { opacity: 0; transform: scale(0.92) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        #offline-banner,#sync-banner{display:none;color:#fff;text-align:center;padding:8px;font-size:0.8rem;font-weight:600;position:fixed;top:0;width:100%;z-index:99999;backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur)} #offline-banner{background:rgba(255, 23, 68, 0.8)} #sync-banner{background:rgba(255, 234, 0, 0.8);color:#000;cursor:pointer;z-index:99998}
        
        #toast-container{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);z-index:9000;display:flex;flex-direction:column;gap:12px;pointer-events:none}
        .toast{background:var(--bg-panel);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);color:var(--text-main);padding:14px 24px;border-radius:30px;font-size:0.9rem;font-weight:600;box-shadow:var(--shadow-lg), inset 0 1px 0 var(--border-light);border:1px solid var(--border);display:flex;align-items:center;gap:12px;animation:fadeSlideUp 0.4s var(--spring) forwards;pointer-events:auto;white-space:nowrap}
        .toast-undo{background:var(--primary);color:#000;border:none;padding:6px 14px;border-radius:20px;cursor:pointer;font-size:0.8rem;font-weight:700;margin-left:10px;transition:all 0.2s} .toast-undo:hover{transform:scale(1.05)}
        
        #login-scr{position:fixed;inset:0;z-index:5000;background:var(--bg-body);display:flex;justify-content:center;align-items:center;transition:opacity 0.8s var(--ease-out-expo),transform 0.8s var(--ease-out-expo)} #login-scr.login-exit{opacity:0;transform:scale(1.05);pointer-events:none}
        .lg-card{background:var(--bg-panel);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);padding:40px 35px;border-radius:32px;border:1px solid var(--border);width:90%;max-width:380px;text-align:center;box-shadow:var(--shadow-lg), inset 0 1px 0 var(--border-light);transition:transform 0.3s;animation:scalePop 0.6s var(--spring)}
        .lg-icon{font-size:3.5rem;color:var(--primary);margin-bottom:15px;filter:drop-shadow(0 0 15px var(--primary-dim))}
        .lg-inp{width:100%;padding:16px;margin-bottom:15px;background:var(--bg-input);border:1px solid var(--border);border-radius:14px;color:var(--text-main);font-size:1.1rem;text-align:center;transition:all 0.3s;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1)} .lg-inp:focus{border-color:var(--primary);background:rgba(0,0,0,0.1);box-shadow:0 0 0 3px var(--primary-dim);transform:translateY(-2px)}
        .btn-lg{width:100%;padding:18px;background:var(--primary);color:#000;font-weight:800;border:none;border-radius:14px;cursor:pointer;font-size:1.05rem;margin-top:20px;transition:all 0.3s;box-shadow:0 8px 20px var(--primary-dim)} .btn-lg:hover{transform:translateY(-2px);filter:brightness(1.1)} .btn-lg:active{transform:scale(0.97)}
        .lg-chk-lbl{color:var(--text-sec);font-size:0.9rem;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:15px;cursor:pointer;font-weight:500} .lg-chk-lbl input{accent-color:var(--primary);width:18px;height:18px;cursor:pointer}
        
        #lg-status-area{min-height:25px;margin-top:15px;font-size:0.85rem;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;opacity:0;transform:translateY(5px);transition:all 0.3s} #lg-status-area.visible{opacity:1;transform:translateY(0)}

        header,.toolbar,main,.footer,.fab{opacity:0;transform:translateY(20px);transition:opacity 0.8s 0.2s var(--ease-out-expo),transform 0.8s 0.2s var(--ease-out-expo)} body.app-ready header,body.app-ready .toolbar,body.app-ready main,body.app-ready .footer,body.app-ready .fab{opacity:1;transform:translateY(0)}
        
        header { height: 65px; background: var(--bg-panel); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; z-index: 20; }
        .h-left { flex: 1; display: flex; align-items: center; gap: 10px; justify-content: flex-start; }
        .h-center { flex: 2; display: flex; justify-content: center; align-items: center; min-width: 0; }
        .h-right { flex: 1; display: flex; align-items: center; gap: 10px; justify-content: flex-end; }
        
        .itunes-display { background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 12px; padding: 0 20px; height: 40px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); max-width: 100%; overflow: hidden; }
        .display-user { font-size: 0.85rem; font-weight: 700; color: var(--text-sec); white-space: nowrap; display: flex; align-items: center; gap: 6px; }
        .display-divider { width: 1px; height: 16px; background: var(--border); opacity: 0.5; }
        
        .status-pill { display:flex; align-items:center; gap:6px; font-size:0.7rem; font-weight:700; text-transform:uppercase; letter-spacing:0.5px}
        .itunes-display .status-pill { background: transparent; border: none; padding: 0; }
        .dot { width: 8px; height: 8px; border-radius: 50%; box-shadow:0 0 8px currentColor}
        .st-online .dot { background: var(--st-online); color: var(--st-online)} .st-fetch .dot { background: var(--st-fetch); animation: pulse 1s infinite; color:var(--st-fetch)} .st-off .dot { background: var(--st-off); color:transparent; box-shadow:none} .st-err .dot { background: var(--st-err); color:var(--st-err)}
        @keyframes pulse { 0%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} 100%{opacity:1;transform:scale(1)} }
        
        .icon-btn{width:36px;height:36px;border-radius:10px;background:transparent;border:1px solid transparent;display:grid;place-items:center;color:var(--text-sec);cursor:pointer;transition:all 0.2s;position:relative;font-size:1.1rem} .icon-btn:hover{background:var(--bg-hover);color:var(--text-main);transform:translateY(-1px)} .icon-btn:active{transform:scale(0.95)} .icon-btn.active-mode{color:var(--primary);background:var(--primary-dim);border-color:var(--primary);box-shadow:0 0 15px var(--primary-dim)}
        
        .toolbar{padding:15px 20px;background: var(--bg-panel); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap;flex-shrink:0;z-index:10} 
        .grp{background:var(--bg-input);border-radius:12px;padding:4px;display:flex;border:1px solid var(--border);height:42px;align-items:center;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1)} 
        .btn-cap{background:transparent;border:none;padding:0 16px;height:32px;border-radius:8px;color:var(--text-sec);font-weight:600;font-size:0.85rem;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap} 
        .btn-cap:hover:not(.active){color:var(--text-main)}
        .btn-cap.active{background:var(--primary);color:#000;box-shadow:0 4px 10px var(--primary-dim)} 
        .btn-cap.active.sede-btn{background:var(--bg-panel);color:var(--text-main);border:1px solid var(--border);box-shadow:var(--shadow-sm)} 
        
        .taller-logo { height: 16px; object-fit: contain; filter: grayscale(1) opacity(0.5) brightness(1.5); transition: 0.3s; }
        .btn-cap.active .taller-logo { filter: none; opacity: 1; }
        body.light-mode .taller-logo { filter: grayscale(1) opacity(0.5) brightness(0); }
        body.light-mode .btn-cap.active .taller-logo { filter: none; opacity: 1; }
        
        .abast-logo { height: 14px; filter: grayscale(1) brightness(2); } .btn-cap.active .abast-logo { filter: brightness(0); } body.light-mode .btn-cap.active .abast-logo { filter: brightness(0); }
        
        .search-bar{display:flex;align-items:center;background:var(--bg-input);border:1px solid var(--border);border-radius:12px;padding:0 15px;height:42px;flex-grow:1;transition:all 0.3s;min-width:200px;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1)} .search-bar:focus-within{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-dim);transform:translateY(-1px)} .search-bar input{background:transparent;border:none;color:var(--text-main);flex:1;margin-left:10px;height:100%;font-size:0.95rem;font-weight:500} mark{background:rgba(255,234,0,0.3);color:inherit;padding:0 2px;border-radius:4px;font-weight:bold}
        
        .loader-line{position:fixed;top:0;left:0;height:4px;width:100%;background:transparent;z-index:9999;overflow:hidden;display:none} .loader-bar{width:100%;height:100%;background:var(--primary);transform:translateX(-100%);animation:load 1.2s infinite;box-shadow:0 0 10px var(--primary)} @keyframes load{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
        
        main{flex-grow:1;overflow-y:auto;overflow-x:auto;padding:0 20px;position:relative;-webkit-overflow-scrolling:touch} 
        .animate-row{animation:fadeSlideUp 0.4s var(--spring) forwards;opacity:0}
        
        #v-pc{width:100%;border-collapse:collapse;min-width:1050px;margin-bottom:20px;margin-top:10px} 
        #v-pc th{text-align:left;padding:18px 15px;color:var(--text-sec);font-size:0.75rem;font-weight:700;text-transform:uppercase;border-bottom:2px solid var(--border);position:sticky;top:0;background:var(--bg-panel);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);z-index:5;cursor:pointer;user-select:none;transition:all 0.3s;letter-spacing:0.5px} 
        #v-pc th:hover{color:var(--text-main);background:var(--bg-hover)} #v-pc th.active-sort{color:var(--primary)} .sort-icon{margin-left:5px;font-size:0.8em;opacity:0.5} #v-pc th.active-sort .sort-icon{opacity:1}
        #v-pc td{padding:16px 15px;border-bottom:1px solid var(--border);font-size:0.95rem;color:var(--text-main);vertical-align:middle;transition:all 0.2s} 
        #v-pc tr:hover td{background:var(--bg-hover);cursor:pointer;color:var(--primary)} #v-pc tr.pinned td{background:rgba(0,230,118,0.05)} .td-diag{max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text-sec)} .pc-only{display:none}
        
        #v-kanban{display:none;gap:20px;padding:20px 0;height:100%;align-items:flex-start} .kb-col{flex:1;background:var(--bg-panel);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);border:1px solid var(--border);border-radius:20px;display:flex;flex-direction:column;min-width:300px;max-height:100%;box-shadow:var(--shadow-sm), inset 0 1px 0 var(--border-light)} .kb-head{padding:18px 20px;border-bottom:1px solid var(--border);font-weight:700;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:transparent;z-index:2;font-size:1.05rem} .kb-body{padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;flex-grow:1} .kb-card{background:var(--bg-input);border:1px solid var(--border);border-radius:14px;padding:16px;cursor:pointer;transition:all 0.3s var(--spring)} .kb-card:hover{border-color:var(--primary-dim);transform:translateY(-3px);background:var(--bg-hover);box-shadow:var(--shadow-sm)} .kb-card.pinned{border-color:var(--primary)}
        
        .badge{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px} .b-green{background:#00e676;box-shadow:0 0 8px #00e676} .b-yellow{background:#ffea00;box-shadow:0 0 8px #ffea00} .b-red{background:#ff1744;box-shadow:0 0 8px #ff1744}
        
        #context-menu{position:absolute;background:var(--bg-panel);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-lg), inset 0 1px 0 var(--border-light);display:none;flex-direction:column;padding:8px;z-index:4000;min-width:180px;animation:fadeSlideUp 0.2s var(--ease)} .cm-item{padding:12px 16px;font-size:0.9rem;color:var(--text-main);display:flex;align-items:center;gap:12px;cursor:pointer;border-radius:10px;transition:all 0.2s;font-weight:600} .cm-item:hover{background:var(--bg-hover);color:var(--primary)} .cm-item.cm-danger:hover{color:var(--st-err);background:rgba(255,23,68,0.1)}
        
        @media (min-width:1024px){.pc-only{display:table} .mob-only{display:none !important}}
        @media (max-width:768px){
            .form-grid{grid-template-columns:1fr;gap:12px} 
            .toolbar{justify-content:space-between; padding:12px 15px;} 
            .search-bar{width:100%}
            .itunes-display { padding: 4px 12px; gap: 8px; min-width: auto; }
            .display-user span.u-text { display: none; } 
            header { padding: 0 15px; }
            .m-box { width: 100%; height: 100vh; max-height: 100vh; border-radius: 0; }
        }

        .mob-only{display:flex;flex-direction:column;gap:15px;padding-bottom:100px;margin-top:15px} .m-card{background:var(--bg-panel);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);padding:18px;border-radius:16px;border:1px solid var(--border);box-shadow:var(--shadow-sm), inset 0 1px 0 var(--border-light);position:relative;cursor:pointer;user-select:none;transition:all 0.2s} .m-card:active{transform:scale(0.96)} .m-card.pinned{border-color:var(--primary-dim);background:linear-gradient(180deg,rgba(0,230,118,0.08) 0%,var(--bg-panel) 100%)} .m-head{display:flex;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:10px;margin-bottom:10px} .m-pat{color:var(--primary);font-weight:800;font-family:monospace;font-size:1.2rem;letter-spacing:1px} body.light-mode .m-head{border-bottom:1px solid rgba(0,0,0,0.05)} .coord-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(0,230,118,0.1);color:var(--primary);font-size:0.75rem;padding:2px 8px;border-radius:4px;border:1px solid rgba(0,230,118,0.2);margin-top:5px}
        
        .chip-btn{display:inline-block;padding:4px 10px;background:var(--bg-hover);border:1px solid var(--border);border-radius:15px;font-size:0.7rem;color:var(--text-sec);cursor:pointer;margin-right:5px;margin-top:5px;transition:0.2s;user-select:none} .chip-btn:hover,.chip-btn.active{background:var(--primary-dim);color:var(--primary);border-color:var(--primary)}
        
        .footer{height:60px;background:var(--bg-panel);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;padding:0 20px;flex-shrink:0;z-index:20;font-size:0.9rem;color:var(--text-sec)} .pg-btn{width:36px;height:36px;background:var(--bg-input);border:1px solid var(--border);color:var(--text-main);border-radius:10px;cursor:pointer;display:grid;place-items:center;transition:all 0.2s;font-size:1.1rem} .pg-btn:hover:not(:disabled){border-color:var(--primary);color:var(--primary)} .pg-btn:disabled{opacity:0.3;cursor:default}
        .fab{position:fixed;bottom:70px;right:20px;width:55px;height:55px;border-radius:50%;background:var(--primary);color:#000;display:grid;place-items:center;font-size:1.5rem;box-shadow:0 5px 20px var(--primary-dim);cursor:pointer;z-index:100;transition:transform 0.2s} .fab:hover{transform:scale(1.1)}
        
        /* MODALES Y FORMS */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:3000;display:none;justify-content:center;align-items:center;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px)} 
        .m-box{background:var(--bg-panel);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);width:95%;max-width:800px;max-height:92vh;border-radius:24px;border:1px solid var(--border);display:flex;flex-direction:column;box-shadow:var(--shadow-lg), inset 0 1px 0 var(--border-light);overflow:hidden;animation:scalePop 0.4s var(--spring)} 
        .m-head-m{padding:20px 25px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:transparent}
        
        .tabs-nav{display:flex;background:var(--bg-input);border-radius:12px;margin:20px 25px 5px 25px;padding:4px;overflow-x:auto} .tab-btn{flex:1;padding:10px 12px;background:transparent;border:none;color:var(--text-sec);font-weight:600;font-size:0.85rem;cursor:pointer;transition:all 0.3s;border-radius:8px;white-space:nowrap} .tab-btn:hover{color:var(--text-main)} .tab-btn.active{color:var(--text-main);background:var(--bg-hover);box-shadow:var(--shadow-sm)}
        body.light-mode .tabs-nav{background:rgba(0,0,0,0.05)} body.light-mode .tab-btn.active{background:#fff; color:#000}

        .m-body-form{padding:25px;overflow-y:auto;flex-grow:1} .tab-pane{display:none;opacity:0} .tab-pane.active{display:block;animation:fadeSlideUp 0.3s ease forwards}
        .form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px} .inp-grp{display:flex;flex-direction:column;position:relative} .inp-lbl{font-size:0.75rem;color:var(--text-sec);font-weight:600;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;text-transform:uppercase}
        
        .inp{width:100%;padding:10px 12px;background:var(--bg-input);border:1px solid var(--border);color:var(--text-main);border-radius:8px;transition:all 0.3s;font-size:0.9rem} .inp:focus{border-color:var(--primary);background:var(--bg-body);box-shadow:0 0 0 2px var(--primary-dim)} .inp:disabled{opacity:0.6;cursor:not-allowed} textarea.inp{resize:vertical}
        
        .save-indicator{font-size:0.7rem;color:var(--st-fetch);margin-left:10px;font-weight:600;opacity:0;transition:0.3s} .save-indicator.show{opacity:1}

        .sig-container{border:2px dashed var(--border);border-radius:16px;background:var(--bg-input);position:relative;transition:all 0.3s} .sig-container:hover{border-color:var(--text-sec)} canvas#sig-pad{width:100%;height:200px;touch-action:none;border-radius:16px;cursor:crosshair} .sig-clear{position:absolute;top:10px;right:10px;background:var(--bg-panel);border:1px solid var(--border);color:var(--text-main);padding:5px 10px;border-radius:6px;font-size:0.7rem;cursor:pointer;transition:all 0.2s} .sig-clear:hover{background:var(--st-err);border-color:var(--st-err)}
        .mic-btn{position:absolute;right:10px;top:32px;color:var(--text-sec);cursor:pointer;transition:all 0.3s;font-size:1.1rem} .mic-btn:hover{color:var(--primary);transform:scale(1.2)} .mic-btn.recording{color:#ff1744;animation:pulse 1s infinite;transform:scale(1.2)} .inp.recording{border-color:#00e676 !important;box-shadow:0 0 15px rgba(0,230,118,0.3) !important}
        
        .m-foot{padding:15px 20px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:10px;background:transparent} .btn-act{flex:1;min-width:140px;padding:12px;background:var(--primary);color:#000;font-weight:700;border:none;border-radius:8px;cursor:pointer;transition:all 0.2s;display:flex;justify-content:center;align-items:center;gap:8px;font-size:0.95rem} .btn-act:active{transform:scale(0.98)} .btn-sec{background:var(--bg-input);color:var(--text-main);border:1px solid var(--border);flex:0.5;font-size:0.85rem} .btn-sec:hover{border-color:var(--primary);color:var(--primary)}
        
        .timer-display{font-family:monospace;font-size:1.2rem;font-weight:800;color:var(--primary);background:var(--bg-input);padding:5px 10px;border-radius:8px;border:1px solid var(--border);text-align:center;letter-spacing:2px;box-shadow:inset 0 2px 5px rgba(0,0,0,0.5)}
        .color-dot{display:inline-block;width:12px;height:12px;border-radius:50%;border:2px solid var(--bg-panel);background:transparent;margin-left:8px;vertical-align:middle;box-shadow:0 0 8px rgba(255,255,255,0.2), 0 0 0 1px var(--text-sec)}

        /* DASHBOARD BARS */
        .bar-wrap{width:100%;background:var(--bg-input);border-radius:10px;height:8px;margin-top:5px;overflow:hidden} .bar-fill{height:100%;background:var(--primary);transition:width 1s ease-out} .stat-row{display:flex;justify-content:space-between;font-size:0.8rem;margin-top:10px}
        input[type=range]{-webkit-appearance:none;width:100%;background:transparent;margin:10px 0} input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;height:16px;width:16px;border-radius:50%;background:var(--primary);cursor:pointer;margin-top:-6px;box-shadow:0 0 10px var(--primary-dim)} input[type=range]::-webkit-slider-runnable-track{width:100%;height:4px;cursor:pointer;background:var(--border);border-radius:2px}
        
        /* MANUAL DE AYUDA */
        .help-section { margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 20px; } .help-section:last-child { border-bottom: none; } .help-title { color: var(--primary); font-size: 1.1rem; margin-top: 0; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; } .help-item { font-size: 0.9rem; color: var(--text-main); margin-bottom: 10px; line-height: 1.5; display: flex; align-items: flex-start; gap: 10px; } .help-item i { color: var(--text-sec); margin-top: 4px; font-size: 1rem; width: 20px; text-align: center; } .help-tag { background: var(--bg-hover); border: 1px solid var(--border); padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; color: var(--primary); font-family: monospace; font-weight:700 }

        /* IMPRESION (NUEVO MÉTODO ANTI BLANK PAGE) */
        @media print {
            body, html { height: auto !important; overflow: visible !important; display: block !important; background: #fff !important; color: #000 !important; }
            body > *:not(#print-area) { display: none !important; }
            * { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; box-shadow: none !important; }
            #print-area { display: block !important; position: relative !important; width: 100% !important; padding: 0 !important; margin: 0 !important; }
            .pr-head { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; text-align: center; } .pr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; } .pr-box { border: 1px solid #000; padding: 8px; border-radius: 4px; break-inside: avoid; } .pr-lbl { font-size: 0.7rem; color: #444; font-weight: bold; text-transform: uppercase; } .pr-val { font-size: 1rem; font-weight: bold; margin-top: 2px; } .pr-sign { text-align: center; border-top: 1px solid #000; width: 250px; padding-top: 5px; margin: 40px auto 0 auto; break-inside: avoid; } .pr-sign img { max-width: 200px; max-height: 80px; margin-top: -80px; display: block; margin-left: auto; margin-right: auto; } .pr-warr { font-size: 0.85rem; line-height: 1.5; margin-top: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; background: #f9f9f9; } .pr-warr h3 { margin-top: 0; text-align: center; text-decoration: underline; }
        }
    </style>
</head>
<body>

    <div id="offline-banner"><i class="fas fa-wifi"></i> Sin Conexión. Guardando localmente...</div>
    <div id="sync-banner" onclick="syncOfflineQueue()"><i class="fas fa-sync fa-spin"></i> Registros pendientes de sincronizar. Toca para enviar.</div>
    <div id="toast-container"></div>
    
    <div id="context-menu">
        <div class="cm-item" onclick="cmAction('edit')"><i class="fas fa-pen"></i> Editar Folio</div>
        <div class="cm-item" onclick="cmAction('pin')" id="cm-pin-text"><i class="fas fa-star"></i> Fijar Arriba</div>
        <div class="cm-item" onclick="cmAction('wsp')"><i class="fab fa-whatsapp" style="color:#25D366"></i> Contactar</div>
        <div class="cm-item" onclick="cmAction('pay')"><i class="fas fa-link" style="color:var(--text-main)"></i> Link de Cobro</div>
        <div class="cm-item" onclick="cmAction('print')"><i class="fas fa-print"></i> Imprimir OT</div>
        <div style="height:1px; background:var(--border); margin:5px 0"></div>
        <div class="cm-item cm-danger" onclick="cmAction('del')"><i class="fas fa-trash"></i> Eliminar</div>
    </div>

    <datalist id="list-marcas"></datalist> <datalist id="list-comunas"></datalist>

    <div id="login-scr">
        <div class="lg-card" id="lg-card">
            <i class="fas fa-fingerprint lg-icon"></i>
            <h2 style="color:var(--text-main); margin:0 0 5px 0; font-weight:800">Bienvenido</h2>
            <p style="color:var(--text-sec); margin-bottom:25px; font-size:0.95rem">JM Autogas V31.2</p>
            <input type="text" id="lg-u" class="lg-inp" placeholder="Usuario" autocomplete="off">
            <input type="tel" id="lg-p" class="lg-inp" placeholder="PIN (Números)" inputmode="numeric" pattern="[0-9]*" maxlength="8" style="-webkit-text-security: disc;">
            <label class="lg-chk-lbl"><input type="checkbox" id="lg-rem"> Recordar mi sesión</label>
            <div id="lg-status-area"></div>
            <button class="btn-lg" onclick="login()">ACCEDER</button>
        </div>
    </div>

    <div class="loader-line" id="loader"><div class="loader-bar"></div></div>

    <header>
        <div class="h-left">
            <div class="icon-btn" onclick="openCalc()" title="Calculadora GLP"><i class="fas fa-gas-pump"></i></div>
            <div class="icon-btn" onclick="openDash()" title="Dashboard"><i class="fas fa-chart-pie"></i></div>
            <div class="icon-btn" id="btn-kanban" onclick="toggleViewMode()" title="Vista Kanban"><i class="fas fa-columns"></i></div>
        </div>
        
        <div class="h-center">
            <div class="itunes-display">
                <div class="display-user" title="Usuario Activo">
                    <i class="fas fa-user-circle"></i> 
                    <span class="u-text" id="u-name">...</span>
                </div>
                <div class="display-divider"></div>
                <div class="status-pill st-off" id="s-pill">
                    <div class="dot"></div><span id="s-txt">Offline</span>
                </div>
            </div>
        </div>
        
        <div class="h-right">
            <div class="icon-btn" onclick="openHelp()" title="Manual de Uso"><i class="fas fa-question-circle" style="color:var(--primary)"></i></div>
            <div class="icon-btn" onclick="toggleTheme()" title="Tema"><i class="fas fa-adjust"></i></div>
            <div class="icon-btn" onclick="toggleFullScreen()" title="Pantalla Completa"><i class="fas fa-expand" id="ic-fs"></i></div>
            <div class="icon-btn" onclick="openCfg()" title="Configuración"><i class="fas fa-cog"></i></div>
            <div class="icon-btn" id="btn-adm" style="display:none; color:var(--primary); border-color:var(--primary-dim)" onclick="openAdm()"><i class="fas fa-users-cog"></i></div>
            <div class="icon-btn btn-danger" onclick="logout()" title="Salir"><i class="fas fa-power-off"></i></div>
        </div>
    </header>

    <div class="toolbar">
        <div class="grp">
            <button class="btn-cap active" onclick="setCat('TALLER', this)">
                <img src="https://ss-cnt-001c.esmsv.com/r/content/host1/5fd8685c621f8af6003145adde3cf37b/img/LOGO.webp" class="taller-logo" alt="Taller">
            </button>
            <button class="btn-cap" onclick="setCat('ABASTIBLE', this)">
                <img src="https://storage.googleapis.com/web-abastible-prod/2025/03/Logo_Abastible.png" class="abast-logo" alt="Abastible">
            </button>
        </div>
        <div class="grp">
            <button class="btn-cap active" onclick="setYear('2026', this)">2026</button>
            <button class="btn-cap" onclick="setYear('2025', this)">2025</button>
            <button class="btn-cap" onclick="setYear('2024', this)">2024</button>
        </div>
        <div class="grp">
            <button class="btn-cap sede-btn active" onclick="setSedeFilter('Todas', this)">Todas</button>
            <button class="btn-cap sede-btn" onclick="setSedeFilter('Conchalí', this)">Conchalí</button>
            <button class="btn-cap sede-btn" onclick="setSedeFilter('San Bernardo', this)">San B.</button>
        </div>
        
        <div class="search-bar" style="position:relative">
            <i class="fas fa-microphone" style="color:var(--primary); cursor:pointer; margin-right:8px; font-size:1.1rem" onclick="toggleSearchDictation()" id="btn-search-mic"></i>
            <input type="text" placeholder="Buscar... (Usa '-' para excluir)" id="q-inp" onkeyup="if(event.key==='Enter'){doSearch(this.value, true)}else{doSearch(this.value, false)}">
        </div>
        
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <span class="chip-btn" onclick="quickFilter('Pendiente', this)">⏳ Pendientes</span>
            <span class="chip-btn" onclick="quickFilter('Entregado', this)">✅ Entregados</span>
            <button class="btn-act btn-sec" id="btn-batch-del" onclick="deleteSelected()" style="display:none; padding:8px 15px; height:38px; color:#ff1744; border-color:rgba(255,23,68,0.3)"><i class="fas fa-trash"></i> Sel.</button>
            <button class="btn-act btn-sec" id="btn-batch" onclick="exportSelected()" style="display:none; padding:8px 15px; height:38px"><i class="fas fa-file-excel"></i> Sel.</button>
            <div class="icon-btn" onclick="exportToCSV()" title="Exportar Excel" style="height:38px; width:38px; background:var(--bg-input)"><i class="fas fa-file-excel"></i></div>
            <div class="icon-btn" onclick="exportPDFTable()" title="Exportar PDF" style="height:38px; width:38px; background:var(--bg-input); color:#ff1744; border-color:rgba(255,23,68,0.3)"><i class="fas fa-file-pdf"></i></div>
        </div>
    </div>

    <main>
        <table id="v-pc" class="pc-only">
            <thead>
                <tr>
                    <th style="width:40px; text-align:center"><input type="checkbox" id="chk-all" onchange="toggleAllChk(this)" style="cursor:pointer; width:16px; height:16px; accent-color:var(--primary)"></th>
                    <th onclick="setSort(0)">Fecha <i class="fas sort-icon" id="si-0"></i></th>
                    <th class="col-1" onclick="setSort(1)">Sede</th>
                    <th class="col-2" onclick="setSort(2)">Ficha</th>
                    <th class="col-3" onclick="setSort(3)">Cliente</th>
                    <th onclick="setSort(9)">Patente</th>
                    <th class="col-5">Vehículo</th>
                    <th class="col-6">Coord.</th>
                    <th class="col-7">Diagnóstico</th>
                </tr>
            </thead>
            <tbody id="tb-pc"></tbody>
        </table>
        
        <div id="v-mob" class="mob-only"></div>

        <div id="v-kanban">
            <div class="kb-col"><div class="kb-head"><span style="color:var(--st-err)"><i class="fas fa-clock"></i> Pendientes</span> <span class="badge b-red" id="k-c1">0</span></div><div class="kb-body" id="k-pend"></div></div>
            <div class="kb-col"><div class="kb-head"><span style="color:var(--st-fetch)"><i class="fas fa-wrench"></i> En Revisión</span> <span class="badge b-yellow" id="k-c2">0</span></div><div class="kb-body" id="k-rev"></div></div>
            <div class="kb-col"><div class="kb-head"><span style="color:var(--primary)"><i class="fas fa-check-circle"></i> Entregados</span> <span class="badge b-green" id="k-c3">0</span></div><div class="kb-body" id="k-ok"></div></div>
        </div>
    </main>

    <div class="footer">
        <div><span id="pg-info">Cargando...</span> <span id="today-count" style="margin-left:15px; color:var(--primary); font-weight:800; font-size:0.95rem"></span></div>
        <div style="display:flex; gap:12px">
            <button class="pg-btn" id="bp" onclick="mv(-1)"><i class="fas fa-chevron-left"></i></button>
            <button class="pg-btn" id="bn" onclick="mv(1)"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <div class="fab" id="fab" onclick="openFormById('new')" title="Nuevo Folio" style="display:none"><i class="fas fa-plus"></i></div>

    <div class="modal" id="m-help" onclick="closeM('m-help')">
        <div class="m-box" onclick="event.stopPropagation()">
            <div class="m-head-m"><h3 style="margin:0; color:var(--primary); font-size:1.3rem"><i class="fas fa-book"></i> Manual de Usuario V31</h3><div class="icon-btn" onclick="closeM('m-help')"><i class="fas fa-times"></i></div></div>
            <div class="m-body-form" style="padding-top:10px">
                <div class="help-section"><h4 class="help-title"><i class="fas fa-shield-alt"></i> 1. Acceso y General</h4><div class="help-item"><i class="fas fa-fingerprint"></i> <b>Recordar Sesión:</b> Marca la casilla al iniciar sesión para entrar automáticamente la próxima vez.</div><div class="help-item"><i class="fas fa-wifi"></i> <b>Modo Offline (Bandeja Inteligente):</b> Si pierdes internet, puedes seguir guardando folios. Se irán a una "Bandeja Local" y se sincronizarán solos al recuperar la señal.</div><div class="help-item"><i class="fas fa-adjust"></i> <b>Memoria de Tema:</b> El botón de Luna/Sol guarda tu preferencia para siempre en el dispositivo actual.</div></div>
                <div class="help-section"><h4 class="help-title"><i class="fas fa-search"></i> 2. Buscador y Filtros Profesionales</h4><div class="help-item"><i class="fas fa-microphone"></i> <b>Búsqueda por Voz:</b> Toca el ícono del micrófono en la barra de búsqueda y dicta el nombre o patente.</div><div class="help-item"><i class="fas fa-minus-circle"></i> <b>Filtro Negativo:</b> Escribe un guion <span class="help-tag">-</span> antes de una palabra para EXCLUIRLA. <i>(Ej: "-Pendiente" muestra todos los autos excepto los pendientes).</i></div><div class="help-item"><i class="fas fa-bolt"></i> <b>Búsqueda Rápida:</b> Presiona <i>"Enter"</i> en el buscador para buscar sin esperar.</div><div class="help-item"><i class="fas fa-tags"></i> <b>Píldoras Rápidas:</b> Toca los botones "⏳ Pendientes" o "✅ Entregados" bajo el buscador para filtrar al instante.</div></div>
                <div class="help-section"><h4 class="help-title"><i class="fas fa-columns"></i> 3. Vistas y Tablero</h4><div class="help-item"><i class="fas fa-table"></i> <b>Modo Kanban vs Tabla:</b> Toca el botón de columnas en la cabecera (arriba a la izquierda) para alternar entre la tabla clásica y un panel de tarjetas arrastrables por estado.</div><div class="help-item"><i class="fas fa-expand"></i> <b>Pantalla Completa:</b> Toca el ícono de las 4 flechas arriba a la derecha para usar la app como un software de escritorio y evitar distracciones.</div><div class="help-item"><i class="fas fa-sort-amount-up"></i> <b>Paginación y Scroll:</b> Al cambiar de página, la tabla te devuelve al inicio automáticamente bloqueando el scroll para evitar saltos molestos. Abajo verás el Total Histórico real.</div></div>
                <div class="help-section"><h4 class="help-title"><i class="fas fa-mouse-pointer"></i> 4. Menú Contextual (Clic Derecho / Tocar Fila)</h4><div class="help-item"><i class="fas fa-star"></i> <b>Fijar Arriba (Pin):</b> Ancla un vehículo a la parte superior de la lista sin importar su fecha. Ideal para los que siguen en el taller.</div><div class="help-item"><i class="fab fa-whatsapp"></i> <b>WhatsApp Rápido:</b> Abre un chat directo con el cliente sin agendar su número.</div><div class="help-item"><i class="fas fa-link"></i> <b>Link de Cobro:</b> Copia al portapapeles un mensaje formal de cobro listo para pegar en WhatsApp.</div><div class="help-item"><i class="fas fa-undo"></i> <b>Eliminación Segura (Undo):</b> Al borrar un folio, tienes 5 segundos para arrepentirte tocando "Deshacer" en la alerta inferior.</div></div>
                <div class="help-section"><h4 class="help-title"><i class="fas fa-edit"></i> 5. Formulario de Folios (Superpoderes)</h4><div class="help-item"><i class="fas fa-lock-open"></i> <b>Modo Candado:</b> Arriba a la derecha del formulario. Úsalo para bloquear la pantalla si solo vas a leer y no quieres borrar nada por error.</div><div class="help-item"><i class="fas fa-save"></i> <b>Borrador Automático:</b> Si se te cierra la ventana por error, al abrir "Nuevo Folio" se recuperará todo. Cierra tocando la parte oscura fuera del cuadro.</div><div class="help-item"><i class="fas fa-font"></i> <b>Auto-Mayúsculas y Autocompletado:</b> Nombres, Marcas y Comunas se formatean solos. Además, el sistema "aprende" de tu base de datos para sugerírtelas.</div><div class="help-item"><i class="fas fa-magic"></i> <b>Varita Mágica (Año):</b> Ingresa una Patente chilena válida, toca la varita y la IA estimará el año del auto. Si es menor a 2010, te lanzará una advertencia.</div><div class="help-item"><i class="fas fa-palette"></i> <b>Punto de Color:</b> Al escribir "Rojo, Blanco, Plata...", aparece un círculo con el color real para una confirmación visual rápida.</div><div class="help-item"><i class="fas fa-camera"></i> <b>Cámara Local:</b> Permite tomar una foto de recepción. <i>Nota: Se borra al recargar la app.</i></div><div class="help-item"><i class="fas fa-stopwatch"></i> <b>Cronómetro:</b> Registra el tiempo exacto que le toma al técnico realizar el trabajo (Play/Pause).</div><div class="help-item"><i class="fas fa-stamp"></i> <b>Auto-Sello de Estado:</b> Al tocar "Entregado" o "Pendiente" en las píldoras de diagnóstico, se añade automáticamente la fecha del día al texto.</div><div class="help-item"><i class="fas fa-signature"></i> <b>Firma Digital:</b> El cliente puede firmar con el dedo en la pantalla para validarlo en la Orden de Trabajo.</div></div>
                <div class="help-section"><h4 class="help-title"><i class="fas fa-chart-line"></i> 6. Herramientas Extra y Exportación</h4><div class="help-item"><i class="fas fa-chart-pie"></i> <b>Dashboard:</b> Analiza la efectividad, suma el KM de la flota, y grafica el rendimiento de los técnicos.</div><div class="help-item"><i class="fas fa-gas-pump"></i> <b>Calculadora ROI GLP:</b> Calcula el ahorro mensual y le dice al cliente en cuántos meses recuperará su inversión.</div><div class="help-item"><i class="fas fa-file-excel"></i> <b>Selección Múltiple (Excel/Borrar):</b> Marca los cuadritos de la tabla para exportar o borrar masivamente y de manera rápida.</div><div class="help-item"><i class="fas fa-file-pdf"></i> <b>Exportador PDF:</b> Genera un reporte limpio de la tabla actual, listo para imprimir.</div><div class="help-item"><i class="fas fa-print"></i> <b>Impresión de OT y Garantía:</b> Genera la Orden de Trabajo o el Certificado de Garantía directamente desde el botón gris del formulario.</div><div class="help-item"><i class="fas fa-download"></i> <b>Respaldo JSON:</b> En configuración, descarga la base de datos completa de forma local por seguridad.</div></div>
            </div>
        </div>
    </div>

    <div class="modal" id="m-form" onclick="closeM('m-form')">
        <div class="m-box" onclick="event.stopPropagation()">
            <div class="m-head-m">
                <div style="display:flex; align-items:center; gap:10px">
                    <h3 style="margin:0; color:var(--text-main); font-size:1.4rem" id="f-ttl">Registro</h3>
                    <span id="save-ind" class="save-indicator"><i class="fas fa-check"></i> Borrador</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px">
                    <div class="icon-btn" onclick="toggleReadOnly()" title="Modo Seguro">
                        <i class="fas fa-lock-open" id="btn-lock"></i>
                    </div>
                    <div class="icon-btn" onclick="closeM('m-form')" title="Cerrar"><i class="fas fa-times"></i></div>
                </div>
            </div>
            
            <div class="tabs-nav">
                <button class="tab-btn active" id="tb-1" onclick="switchTab(1)"><i class="fas fa-info-circle"></i> General</button>
                <button class="tab-btn" id="tb-2" onclick="switchTab(2)"><i class="fas fa-car"></i> Vehículo</button>
                <button class="tab-btn" id="tb-3" onclick="switchTab(3)"><i class="fas fa-tools"></i> Trabajo</button>
                <button class="tab-btn" id="tb-4" onclick="switchTab(4)"><i class="fas fa-signature"></i> Firma</button>
            </div>

            <div class="m-body-form" id="f-body">
                <input type="hidden" id="f-id">
                
                <div class="tab-pane active" id="tab-1">
                    <div class="form-grid">
                        <div class="inp-grp"><span class="inp-lbl">FECHA *</span><input type="date" id="i_fec" class="inp" onchange="doSaveDraft()"></div>
                        <div class="inp-grp"><span class="inp-lbl">SEDE *</span><select id="i_sede" class="inp" onchange="doSaveDraft()"></select></div>
                        <div class="inp-grp"><span class="inp-lbl">FICHA</span><input type="text" id="i_fic" class="inp" onchange="doSaveDraft()"></div>
                        
                        <div class="inp-grp" style="grid-column: span 2">
                            <span class="inp-lbl">CLIENTE</span>
                            <input type="text" id="i_cli" class="inp" onblur="toTitleCase(this)" onchange="doSaveDraft()">
                        </div>

                        <div class="inp-grp"><span class="inp-lbl">RUT</span><input type="text" id="i_rut" class="inp" oninput="formatRut(this)" onchange="doSaveDraft()"></div>
                        <div class="inp-grp"><span class="inp-lbl">CELULAR</span><input type="text" id="i_cel" class="inp" oninput="this.value=this.value.replace(/[^0-9+ ]/g,'')" placeholder="+569..." onchange="doSaveDraft()"></div>
                        <div class="inp-grp" style="grid-column: span 2"><span class="inp-lbl">COMUNA</span><input type="text" id="i_com" class="inp" list="list-comunas" onblur="toTitleCase(this)" onchange="doSaveDraft()"></div>
                    </div>
                </div>

                <div class="tab-pane" id="tab-2">
                    <div class="form-grid">
                        <div class="inp-grp">
                            <span class="inp-lbl">PATENTE * <i class="fas fa-magic" style="color:var(--primary); cursor:pointer; font-size:1.1rem; transition:transform 0.3s" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" onclick="guessYear()" title="Estimar Año"></i></span>
                            <input type="text" id="i_pat" class="inp" style="border-color:var(--primary); font-weight:800; text-transform:uppercase; letter-spacing:2px; font-size:1.1rem" oninput="formatPat(this)" onchange="doSaveDraft()">
                        </div>
                        <div class="inp-grp"><span class="inp-lbl">MARCA</span><input type="text" id="i_mar" class="inp" list="list-marcas" onblur="toTitleCase(this)" onchange="doSaveDraft()"></div>
                        <div class="inp-grp"><span class="inp-lbl">MODELO</span><input type="text" id="i_mod" class="inp" onblur="toTitleCase(this)" onchange="doSaveDraft()"></div>
                        
                        <div class="inp-grp">
                            <span class="inp-lbl">AÑO</span>
                            <input type="number" id="i_ano" class="inp" onchange="doSaveDraft()">
                            <div id="alert-old-car" style="background:rgba(255,234,0,0.1);border:1px solid var(--st-fetch);color:var(--st-fetch);padding:10px;border-radius:8px;font-size:0.75rem;margin-top:8px;display:none;align-items:center;gap:8px;animation:fadeSlideUp 0.3s var(--ease)"><i class="fas fa-exclamation-triangle" style="font-size:1.1rem"></i> Año &lt; 2010. Sugerir revisión profunda.</div>
                        </div>
                        
                        <div class="inp-grp"><span class="inp-lbl">COLOR <span class="color-dot" id="c-dot"></span></span><input type="text" id="i_col" class="inp" onblur="toTitleCase(this)" oninput="updateColorDot(this.value)" onchange="doSaveDraft()"></div>
                        
                        <div class="inp-grp"><span class="inp-lbl">KM</span><input type="number" id="i_km" class="inp" onchange="doSaveDraft()" style="font-family:monospace; font-weight:600"></div>
                        
                        <div class="inp-grp" style="grid-column: span 3; background:var(--bg-hover); padding:15px; border-radius:12px; border:1px solid var(--border)">
                            <span class="inp-lbl">FOTO RECEPCIÓN (Modo Local)</span>
                            <div style="display:flex; gap:15px; align-items:center; margin-top:5px">
                                <label style="background:var(--primary); color:#000; padding:10px 20px; border-radius:10px; cursor:pointer; font-size:0.85rem; font-weight:800; transition:all 0.3s var(--ease); box-shadow:0 4px 10px var(--primary-dim)"><i class="fas fa-camera" style="margin-right:5px"></i> Tomar Foto <input type="file" accept="image/*" capture="environment" style="display:none" onchange="handleCam(this)"></label>
                                <img id="cam-preview" src="" style="display:none; height:50px; border-radius:6px; border:2px solid var(--primary); box-shadow:var(--shadow-sm)">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="tab-3">
                    <div class="form-grid">
                        <div class="inp-grp" style="grid-column: span 2"><span class="inp-lbl">TÉCNICO *</span><select id="i_tec" class="inp" onchange="doSaveDraft()"></select></div>
                        
                        <div class="inp-grp" style="grid-column: span 2; display:flex; flex-direction:row; align-items:center; gap:20px; background:var(--bg-input); border-radius:12px; padding:8px 20px; border:1px solid var(--border)">
                            <div style="flex:1"><span class="inp-lbl" style="margin:0; font-size:0.7rem">TIEMPO REPARACIÓN</span><div class="timer-display" id="tt-disp">00:00:00</div></div>
                            <button class="btn-act btn-sec" style="padding:12px; flex:0; width:50px; height:50px; border-radius:50%; border:2px solid var(--primary); color:var(--primary)" id="btn-tt" onclick="toggleTimer()"><i class="fas fa-play" style="margin-left:3px"></i></button>
                        </div>
                        
                        <div class="inp-grp" style="grid-column: span 3; background:var(--bg-input); padding:15px; border-radius:12px; border:1px solid var(--border)">
                            <span class="inp-lbl" style="margin-bottom:12px">INSPECCIÓN VISUAL RÁPIDA</span>
                            <div style="display:flex; gap:10px; flex-wrap:wrap">
                                <span class="chip-btn" onclick="addChip('i_dia', '🟢 Aceite OK')">🟢 Aceite OK</span>
                                <span class="chip-btn" onclick="addChip('i_dia', '🔴 Sin Aceite')">🔴 Sin Aceite</span>
                                <span class="chip-btn" onclick="addChip('i_dia', '🟢 Agua OK')">🟢 Agua OK</span>
                                <span class="chip-btn" onclick="addChip('i_dia', '🟡 Batería Débil')">🟡 Batería</span>
                            </div>
                        </div>

                        <div class="inp-grp" style="grid-column: span 3">
                            <span class="inp-lbl">DIAGNÓSTICO ESTADO <span id="dia-count" style="font-weight:normal; text-transform:none; font-family:monospace">0/300</span></span>
                            <textarea id="i_dia" class="inp" rows="4" maxlength="300" oninput="document.getElementById('dia-count').innerText=this.value.length+'/300'; doSaveDraft()"></textarea>
                            <i class="fas fa-microphone mic-btn" id="btn-mic" onclick="toggleDictation('i_dia')" title="Dictar por voz"></i>
                            <div style="margin-top:10px">
                                <span class="chip-btn" onclick="addChipWithDate('i_dia', '⏳ Pendiente')">⏳ Pendiente</span>
                                <span class="chip-btn" onclick="addChipWithDate('i_dia', '🔍 En Revisión')">🔍 En Revisión</span>
                                <span class="chip-btn" onclick="addChipWithDate('i_dia', '✅ Entregado')">✅ Entregado</span>
                            </div>
                        </div>
                        
                        <div class="inp-grp" style="grid-column: span 3"><span class="inp-lbl">MATERIALES / EQUIPO</span><input type="text" id="i_mat" class="inp" onchange="doSaveDraft()"></div>
                    </div>
                </div>

                <div class="tab-pane" id="tab-4">
                    <p style="font-size:0.9rem; color:var(--text-sec); margin-top:0; font-weight:600">Firma del cliente para impresión de OT.</p>
                    <div class="sig-container"><canvas id="sig-pad"></canvas><button class="sig-clear" onclick="clearSignature()"><i class="fas fa-eraser"></i> Borrar</button></div>
                </div>
            </div>
            
            <div class="m-foot">
                <button class="btn-act btn-sec" id="btn-print" onclick="printOT()" style="display:none; flex:0.3" title="Imprimir OT"><i class="fas fa-print"></i> Orden Trabajo</button>
                <button class="btn-act btn-sec" id="btn-warr" onclick="printGarantia()" style="display:none; flex:0.3" title="Garantía"><i class="fas fa-certificate"></i> Garantía</button>
                <button class="btn-act" id="btn-s" onclick="save()"><i class="fas fa-save"></i> GUARDAR REGISTRO</button>
            </div>
        </div>
    </div>

    <div class="modal" id="m-calc" onclick="closeM('m-calc')">
        <div class="m-box" style="max-width:420px" onclick="event.stopPropagation()">
            <div class="m-head-m"><h3 style="margin:0; color:var(--text-main); font-size:1.3rem"><i class="fas fa-gas-pump" style="color:var(--primary)"></i> Retorno GLP</h3><div class="icon-btn" onclick="closeM('m-calc')"><i class="fas fa-times"></i></div></div>
            <div style="padding:25px; overflow-y:auto">
                <div class="inp-grp" style="margin-bottom:20px"><span class="inp-lbl">VALOR INSTALACIÓN ($)</span><input type="number" id="calc_val" class="inp" value="850000" oninput="calcAhorro()" style="font-size:1.2rem; font-weight:700"></div>
                <div class="inp-grp" style="margin-bottom:20px"><span class="inp-lbl">KM MENSUALES: <span id="v_km" style="color:var(--text-main); font-size:1rem">1500</span></span><input type="range" id="calc_km" min="500" max="10000" step="100" value="1500" oninput="document.getElementById('v_km').innerText=this.value; calcAhorro()"></div>
                <div class="inp-grp" style="margin-bottom:20px"><span class="inp-lbl">RENDIMIENTO (KM/L): <span id="v_rend" style="color:var(--text-main); font-size:1rem">10</span></span><input type="range" id="calc_rend" min="4" max="25" step="0.5" value="10" oninput="document.getElementById('v_rend').innerText=this.value; calcAhorro()"></div>
                <div style="background:var(--bg-input); padding:20px; border-radius:16px; text-align:center; border:2px solid var(--primary-dim); box-shadow:0 10px 30px rgba(0,0,0,0.3)">
                    <div style="font-size:0.85rem; color:var(--text-sec); font-weight:800; text-transform:uppercase; letter-spacing:1px">Ahorro Mensual Estimado</div>
                    <div id="calc_res" style="font-size:2.8rem; font-weight:800; color:var(--primary); margin:10px 0; text-shadow:0 0 20px var(--primary-dim)">$0</div>
                    <div id="calc_roi" style="font-size:0.95rem; color:var(--st-fetch); margin-top:5px; font-weight:700; background:rgba(255,234,0,0.1); padding:5px; border-radius:6px">...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="m-dash" onclick="closeM('m-dash')"><div class="m-box" style="max-width:450px" onclick="event.stopPropagation()"><div class="m-head-m"><h3 style="margin:0; font-size:1.3rem"><i class="fas fa-chart-pie" style="color:var(--primary)"></i> Dashboard</h3><div class="icon-btn" onclick="closeM('m-dash')"><i class="fas fa-times"></i></div></div><div style="padding:25px" id="dash-body"></div></div></div>
    
    <div class="modal" id="m-cfg" onclick="closeM('m-cfg')"><div class="m-box" style="max-width:450px" onclick="event.stopPropagation()"><div class="m-head-m"><h3 style="margin:0; font-size:1.3rem"><i class="fas fa-cog" style="color:var(--text-sec)"></i> Configuración</h3><div class="icon-btn" onclick="closeM('m-cfg')"><i class="fas fa-times"></i></div></div><div style="padding:25px"><div style="display:flex; gap:12px; margin-bottom:20px"><select id="c-cat" class="inp" style="flex:1"><option value="SEDE">SEDE</option><option value="TECNICO">TECNICO</option></select><input type="text" id="c-val" class="inp" placeholder="Nuevo valor..." style="flex:2"><button class="btn-act" style="width:60px" onclick="addCfg()">+</button></div><div id="cfg-list" style="max-height:300px; overflow:auto; border:1px solid var(--border); border-radius:12px; background:var(--bg-input); padding:5px"></div><button class="btn-act btn-sec" style="margin-top:20px; width:100%" onclick="exportBackupJSON()"><i class="fas fa-download"></i> Respaldar Base (JSON)</button></div></div></div>

    <div class="modal" id="m-usr" onclick="closeM('m-usr')"><div class="m-box" style="max-width:450px" onclick="event.stopPropagation()"><div class="m-head-m"><h3 style="margin:0; font-size:1.3rem"><i class="fas fa-users-cog" style="color:var(--primary)"></i> Usuarios</h3><div class="icon-btn" onclick="closeM('m-usr')"><i class="fas fa-times"></i></div></div><div style="padding:25px"><div style="background:var(--bg-input); padding:20px; border-radius:16px; border:1px solid var(--border); margin-bottom:20px"><input type="text" id="u-new" class="inp" placeholder="Usuario" style="margin-bottom:12px"><input type="text" id="p-new" class="inp" placeholder="Clave (Números)" style="margin-bottom:12px"><label style="font-size:0.9rem; color:var(--text-main); font-weight:700; display:flex; align-items:center; gap:8px"><input type="checkbox" id="adm-chk" style="accent-color:var(--primary); width:18px; height:18px"> ADMIN TOTAL</label><button class="btn-act" style="margin-top:20px; width:100%" onclick="addUsr()">Crear Usuario</button></div><div id="usr-list" style="border:1px solid var(--border); border-radius:12px; overflow:hidden"></div></div></div></div>

    <div id="print-area" style="display:none;"></div>

<script>
    // --- VARIABLES GLOBALES ---
    const API_URL = "https://script.google.com/macros/s/AKfycbxWikUL6ErRmzZJNWVikLp2g3AtwL0QCM8DXkJuTZ6baBGUYGm8wwKt98lGoycdwty6/exec";
    let S = { cat:'TALLER', year:'2026', page:1, data:[], user:null, lists:[], users:[], q:'', timer:null, sort: { col: null, asc: false }, sedeFilter: 'Todas', pinned: [], viewMode: 'table', qFilter: null, totalHist: null };
    const MAP=['i_fec','i_sede','i_fic','i_cli','i_rut','i_cel','i_com','i_mar','i_mod','i_pat','i_col','i_km','i_ano','i_coo','i_dia','i_tec','i_mat'];

    // --- UTILIDADES GLOBALES ---
    window.onclick = function(event) { if (event.target.classList.contains('modal')) event.target.style.display = "none"; }
    function openHelp() { document.getElementById('m-help').style.display = 'flex'; }
    if(localStorage.getItem('theme') === 'light' || (!localStorage.getItem('theme') && window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches)) document.body.classList.add('light-mode');
    function toggleTheme() { document.body.classList.toggle('light-mode'); localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark'); }
    function toggleFullScreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err=>{}); document.getElementById('ic-fs').className='fas fa-compress'; } else { document.exitFullscreen(); document.getElementById('ic-fs').className='fas fa-expand'; } }
    
    // --- OFFLINE & TOASTS ---
    window.addEventListener('offline', () => document.getElementById('offline-banner').style.display = 'block');
    window.addEventListener('online', () => { document.getElementById('offline-banner').style.display = 'none'; checkOfflineQueue(); });
    function checkOfflineQueue() { let q = JSON.parse(localStorage.getItem('jmautogas_queue') || '[]'); document.getElementById('sync-banner').style.display = q.length > 0 ? 'block' : 'none'; }
    async function syncOfflineQueue() {
        let q = JSON.parse(localStorage.getItem('jmautogas_queue') || '[]'); if(q.length === 0) return;
        document.getElementById('sync-banner').innerText = "Sincronizando...";
        try { for(let p of q) { let params = new URLSearchParams(); for(let k in p) params.append(k, p[k]); await apiCall({}, params); }
            localStorage.removeItem('jmautogas_queue'); showToast("Sincronización completada."); checkOfflineQueue(); load();
        } catch(e) { document.getElementById('sync-banner').innerText = "Error. Toca para reintentar."; }
    }
    function showToast(msg, undoId = null) {
        let box = document.createElement('div'); box.className = 'toast';
        let html = `<span>${msg}</span>`; if(undoId) html += `<button class="toast-undo" onclick="cancelUndo('${undoId}', this.parentElement)">Deshacer</button>`;
        box.innerHTML = html; document.getElementById('toast-container').appendChild(box);
        setTimeout(() => { if(box.parentElement) box.remove(); }, undoId ? 5000 : 3000);
    }

    // --- CONEXION API & LOADER FIJO ---
    let activeReqs = 0;
    function st(c) { let p=document.getElementById('s-pill'), t=document.getElementById('s-txt'); p.className = `status-pill st-${c}`; t.innerText = c==='online'?'Online':(c==='fetch'?'Cargando':(c==='recv'?'Procesando':(c==='err'?'Error':'Offline'))); }
    function ld(show) { 
        if(show) activeReqs++; else activeReqs--;
        if(activeReqs < 0) activeReqs = 0;
        let l = document.getElementById('loader');
        if(l) l.style.display = activeReqs > 0 ? 'block' : 'none'; 
        let m = document.querySelector('main');
        if(m) { m.style.overflowY = activeReqs > 0 ? 'hidden' : 'auto'; m.style.overflowX = activeReqs > 0 ? 'hidden' : 'auto'; }
    }
    function closeM(id){ document.getElementById(id).style.display='none'; }

    async function apiCall(params, body = null) {
        if(!navigator.onLine && !body) throw new Error("Offline GET");
        if(!navigator.onLine && body) {
            let q = JSON.parse(localStorage.getItem('jmautogas_queue') || '[]'); let obj = {}; body.forEach((v,k)=>obj[k]=v); q.push(obj);
            localStorage.setItem('jmautogas_queue', JSON.stringify(q)); checkOfflineQueue(); return {status:'ok_offline'};
        }
        st('fetch'); ld(true);
        try {
            let url = new URL(API_URL); Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            let r = await fetch(url, body ? { method: 'POST', body: body, mode: 'no-cors' } : {});
            st('recv'); if (body && r.type === 'opaque') return { status: 'ok' }; return await r.json();
        } catch (e) { 
            st('off'); throw e; 
        } finally { ld(false); }
    }

    // --- LOGIN SEGURO PARA NÚMEROS Y TEXTO ---
    document.addEventListener("DOMContentLoaded", async () => { 
        let sc = localStorage.getItem('jm_auth'); 
        if(sc) { let c = JSON.parse(atob(sc)); document.getElementById('lg-u').value = c.u; document.getElementById('lg-p').value = c.p; login(); } 
    });

    async function login() {
        let u_in=document.getElementById('lg-u').value, p_in=document.getElementById('lg-p').value; if(!u_in || !p_in) return;
        let lgStat = document.getElementById('lg-status-area');
        if(lgStat) { lgStat.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...'; lgStat.classList.add('visible'); lgStat.style.color = '#fff'; }
        
        try {
            let [j_usr, j_cfg] = await Promise.all([apiCall({type:'users'}), apiCall({type:'config'})]);
            S.users=j_usr.data || []; S.lists=j_cfg.data || [];
            
            let f = S.users.find(x => String(x.user || '').trim().toLowerCase() === String(u_in).trim().toLowerCase() && String(x.pass || '').trim() === String(p_in).trim());
            
            if(f){
                if(lgStat) { lgStat.innerHTML = '<i class="fas fa-check"></i> Acceso Autorizado'; lgStat.style.color = 'var(--st-online)'; }
                S.user=f; 
                if(document.getElementById('lg-rem').checked) localStorage.setItem('jm_auth', btoa(JSON.stringify({u:u_in, p:p_in})));
                
                setTimeout(() => {
                    document.getElementById('login-scr').classList.add('login-exit'); document.body.classList.add('app-ready');
                    setTimeout(() => {
                        document.getElementById('login-scr').style.display='none'; 
                        
                        let userNameDisplay = String(f.user).split(' ')[0];
                        let uSpan = document.getElementById('u-name');
                        if(uSpan) uSpan.innerText = userNameDisplay;
                        
                        if(f.perms === 'ALL' || (typeof f.perms === 'string' && f.perms.includes('ADD'))) { document.getElementById('fab').style.display = 'grid'; }
                        if(f.perms === 'ALL') document.getElementById('btn-adm').style.display='grid';
                        
                        let localPins = localStorage.getItem('jmautogas_pins');
                        try { S.pinned = localPins ? JSON.parse(localPins) : []; } catch(e) { S.pinned = []; }
                        if(!Array.isArray(S.pinned)) S.pinned = [];
                        
                        st('online'); checkOfflineQueue(); load();
                    }, 800);
                }, 500);
            } else {
                if(lgStat) { lgStat.innerHTML = '<i class="fas fa-times"></i> Credenciales Incorrectas'; lgStat.style.color = 'var(--st-err)'; lgStat.classList.add('shake'); setTimeout(()=>lgStat.classList.remove('shake'), 400); }
                showToast("Usuario o PIN incorrectos");
            }
        } catch(e){ 
            if(lgStat) { lgStat.innerHTML = '<i class="fas fa-wifi"></i> Error de conexión'; lgStat.style.color = 'var(--st-err)'; }
            showToast("Error de Red. Revisa tu conexión."); st('off'); 
        }
    }
    
    function logout() { localStorage.removeItem('jm_auth'); location.reload(); }

    // --- FILTROS Y CARGA ---
    function setCat(c,b){ S.cat=c; document.body.classList.toggle('abastible-mode', c==='ABASTIBLE'); upd(b,0); S.page=1; load(); }
    function setYear(y,b){ S.year=y; upd(b,1); S.page=1; load(); }
    function setSedeFilter(f,b){ S.sedeFilter = f; upd(b,2); render(); }
    function upd(b,g){ document.querySelectorAll('.grp')[g].querySelectorAll('.btn-cap').forEach(e=>e.classList.remove('active')); b.classList.add('active'); }
    function setSort(col) { if (S.sort.col === col) S.sort.asc = !S.sort.asc; else { S.sort.col = col; S.sort.asc = true; } S.page = 1; load(); }
    function doSearch(v, instant = false){ S.q=v; S.qFilter=null; document.querySelectorAll('.chip-btn').forEach(c=>c.classList.remove('active')); if(instant) { clearTimeout(S.timer); S.page=1; load(); } else { clearTimeout(S.timer); S.timer=setTimeout(()=>{ S.page=1; load(); }, 600); } }
    function quickFilter(term, btn) { document.querySelectorAll('.chip-btn').forEach(c=>c.classList.remove('active')); btn.classList.add('active'); document.getElementById('q-inp').value=''; S.q=''; S.qFilter=term; S.page=1; load(); }
    function toggleViewMode() { S.viewMode = S.viewMode === 'table' ? 'kanban' : 'table'; document.getElementById('btn-kanban').classList.toggle('active-mode', S.viewMode==='kanban'); render(); }

    async function load() {
        let pcTb = document.getElementById('tb-pc');
        if(pcTb) pcTb.style.opacity = '0.5';
        
        try {
            let params = { sheetName: (S.cat==='TALLER'?'Folios ':'ABASTIBLE ')+S.year, page: S.page };
            if(S.q && !S.q.startsWith('-')) params.search = S.q; 
            if(S.qFilter) params.search = S.qFilter;
            if(S.sort.col !== null) { params.sortCol = S.sort.col; params.sortAsc = S.sort.asc; }
            
            let j = await apiCall(params); 
            S.data=j.data||[]; 
            
            if(j.total !== undefined) S.totalHist = j.total; else if(j.totalRows !== undefined) S.totalHist = j.totalRows; else if(j.count !== undefined) S.totalHist = j.count; else if(j.total_rows !== undefined) S.totalHist = j.total_rows;
            
            let mSet = new Set(), cSet = new Set(); S.data.forEach(r=>{if(r[7]) mSet.add(r[7]); if(r[6]) cSet.add(r[6]);});
            document.getElementById('list-marcas').innerHTML = Array.from(mSet).map(m=>`<option value="${m}">`).join('');
            document.getElementById('list-comunas').innerHTML = Array.from(cSet).map(c=>`<option value="${c}">`).join('');
            
            render(); st('online');
        } catch(e){ st('off'); } finally { if(pcTb) pcTb.style.opacity = '1'; }
    }

    function hl(text) { if(!text) return '-'; let q = S.q || S.qFilter; if(!q || q.startsWith('-')) return text; return text.toString().replace(new RegExp(`(${q})`, 'gi'), `<mark>$1</mark>`); }
    function getStatusBadge(diag) {
        if(!diag) return {b: '', s: 'pend'}; let d = diag.toLowerCase();
        if(d.includes('entregado') || d.includes('listo') || d.includes('ok')) return {b: '<span class="badge b-green"></span>', s: 'ok'};
        if(d.includes('revisión') || d.includes('revision') || d.includes('proceso')) return {b: '<span class="badge b-yellow"></span>', s: 'rev'};
        return {b: '<span class="badge b-red"></span>', s: 'pend'};
    }

    // --- MENU CONTEXTUAL ANTI-ROTURAS ---
    function showCtx(e, id) {
        e.preventDefault(); e.stopPropagation();
        document.getElementById('context-menu').setAttribute('data-target-id', id);
        let menu = document.getElementById('context-menu'); menu.style.display = 'flex';
        menu.style.left = Math.min(e.pageX, window.innerWidth - 180) + 'px'; menu.style.top = e.pageY + 'px';
        document.getElementById('cm-pin-text').innerHTML = S.pinned.includes(String(id)) ? '<i class="fas fa-star-half-alt"></i> Desfijar' : '<i class="fas fa-star"></i> Fijar Arriba';
    }
    
    document.addEventListener('click', (e) => { 
        if(!e.target.closest('#context-menu')) { let cm = document.getElementById('context-menu'); if(cm) cm.style.display = 'none'; }
    });

    function cmAction(act) {
        let id = document.getElementById('context-menu').getAttribute('data-target-id');
        if(!id) return; let r = S.data.find(x => String(x[x.length-1]) === String(id)); if(!r) return;
        
        if(act === 'edit') openFormById(id);
        else if(act === 'pin') { let sId = String(id); if(S.pinned.includes(sId)) S.pinned = S.pinned.filter(x=>x!==sId); else S.pinned.push(sId); localStorage.setItem('jmautogas_pins', JSON.stringify(S.pinned)); render(); }
        else if(act === 'wsp') { let cel = r[5]; if(!cel) return showToast("Sin celular registrado"); let cCel = cel.toString().replace(/\s+/g,''); cCel = cCel.startsWith('+') ? cCel : '+569' + cCel.slice(-8); window.open(`https://wa.me/${cCel.replace('+','')}`, '_blank'); }
        else if(act === 'pay') { navigator.clipboard.writeText(`Hola ${r[3]},\nPara realizar el pago puedes utilizar nuestro enlace seguro:\n[Link Webpay]\n\nAtte. JM Autogas.`).then(()=>showToast("Texto copiado al portapapeles")); }
        else if(act === 'print') { openFormById(id); setTimeout(printOT, 500); }
        else if(act === 'del') { confirmDelete(id); }
        document.getElementById('context-menu').style.display = 'none';
    }

    // --- ABRIR FOLIO (CLICK DIRECTO EN LA FILA) ---
    window.openFormById = function(id) {
        try {
            if(id === 'new') { form(null); return; }
            let rowData = S.data.find(x => String(x[x.length-1]) === String(id));
            if (rowData) form(rowData);
        } catch(e) { console.error("Error abriendo form:", e); showToast("Error al abrir el folio."); }
    };

    // DELEGACION MODO TABLA
    document.addEventListener('click', (e) => { 
        let row = e.target.closest('.animate-row');
        if(row && row.hasAttribute('data-id') && !e.target.closest('.row-chk') && !e.target.closest('td:first-child')) {
            let id = row.getAttribute('data-id'); 
            window.openFormById(id);
        }
    });
    document.addEventListener('contextmenu', (e) => {
        let row = e.target.closest('.animate-row');
        if(row && row.hasAttribute('data-id')) {
            e.preventDefault(); let id = row.getAttribute('data-id');
            showCtx(e, id);
        }
    });

    function render() {
        try {
            let pc=document.getElementById('tb-pc'), mob=document.getElementById('v-mob'), kP=document.getElementById('k-pend'), kR=document.getElementById('k-rev'), kO=document.getElementById('k-ok');
            pc.innerHTML=''; mob.innerHTML=''; kP.innerHTML=''; kR.innerHTML=''; kO.innerHTML='';
            let kpC=0, krC=0, koC=0; let fd = S.data || [];
            
            if(S.sedeFilter !== 'Todas') fd = fd.filter(r => r[1] && r[1].toUpperCase() === S.sedeFilter.toUpperCase());
            if(S.q && S.q.startsWith('-')) { let neg = S.q.substring(1).toLowerCase(); fd = fd.filter(r => !r.join(' ').toLowerCase().includes(neg)); }
            
            let tStr = new Date().toLocaleDateString('en-CA'); let todayCount = fd.filter(r => r[0] && r[0].includes(tStr)).length;
            document.getElementById('today-count').innerText = todayCount > 0 ? `| Ingresos Hoy: ${todayCount}` : '';

            fd.sort((a,b) => { let ap = S.pinned.includes(String(a[a.length-1])), bp = S.pinned.includes(String(b[b.length-1])); return (ap === bp) ? 0 : ap ? -1 : 1; });

            document.getElementById('v-pc').style.display = (S.viewMode==='table' && window.innerWidth>=1024) ? 'table' : 'none';
            mob.style.display = (S.viewMode==='table' && window.innerWidth<1024) ? 'flex' : 'none';
            document.getElementById('v-kanban').style.display = S.viewMode==='kanban' ? 'flex' : 'none';

            fd.forEach((r, i)=>{
                let id = String(r[r.length-1]); let d=r[0]; if(d&&d.includes('T')) d=d.split('T')[0];
                let isP = S.pinned.includes(id); let stat = getStatusBadge(r[14]);
                
                if(S.viewMode === 'table') {
                    if(window.innerWidth >= 1024) {
                        let tr=document.createElement('tr'); tr.className = `animate-row ${isP?'pinned':''}`; tr.setAttribute('data-id', id);
                        // ALINEACION CHECKBOX REPARADA (td width:40px; text-align:center)
                        tr.innerHTML=`<td style="width:40px; text-align:center" onclick="event.stopPropagation()"><input type="checkbox" class="row-chk" value="${id}" onclick="event.stopPropagation()" style="cursor:pointer; width:16px; height:16px; accent-color:var(--primary)"></td>
                        <td>${isP?'<i class="fas fa-star" style="color:var(--primary); font-size:0.7rem"></i> ':''}${hl(d)}</td><td class="col-1">${hl(r[1])}</td><td class="col-2">${hl(r[2])}</td><td class="col-3" style="font-weight:700">${hl(r[3])}</td><td style="color:var(--primary);font-family:monospace;font-weight:800">${hl(r[9])}</td><td class="col-5">${hl(r[7])} ${hl(r[8])}</td><td class="col-6" style="color:var(--text-sec);font-size:0.85rem">${hl(r[13])}</td><td class="col-7 td-diag" title="${r[14]}">${stat.b}${hl(r[14])}</td>`;
                        pc.appendChild(tr);
                    } else if(i < 15) {
                        let c=document.createElement('div'); c.className=`m-card animate-row ${isP?'pinned':''}`; c.setAttribute('data-id', id);
                        c.innerHTML=`<div class="m-head"><span class="m-pat">${isP?'<i class="fas fa-star" style="font-size:0.9rem"></i> ':''}${hl(r[9])}</span><small style="font-weight:600">${hl(d)}</small></div><div style="font-weight:700; margin-bottom:6px; font-size:1.05rem">${hl(r[3])}</div><div style="font-size:0.9rem;color:var(--text-sec);">${stat.b}${hl(r[14])}</div>`;
                        mob.appendChild(c);
                    }
                } else {
                    let kCard = `<div class="kb-card animate-row ${isP?'pinned':''}" data-id="${id}"><div style="display:flex; justify-content:space-between; margin-bottom:5px"><span style="font-family:monospace; font-weight:800; color:var(--primary)">${hl(r[9])}</span><span style="font-size:0.75rem; font-weight:600; color:var(--text-sec)">${hl(d)}</span></div><div style="font-weight:700; font-size:0.95rem">${hl(r[3])}</div><div style="font-size:0.85rem; color:var(--text-sec); margin-top:5px">${hl(r[7])} ${hl(r[8])}</div><div style="font-size:0.8rem; margin-top:8px; padding-top:8px; border-top:1px solid var(--border); font-weight:600">${hl(r[14])}</div></div>`;
                    if(stat.s === 'pend') { kP.innerHTML += kCard; kpC++; } else if(stat.s === 'rev') { kR.innerHTML += kCard; krC++; } else { kO.innerHTML += kCard; koC++; }
                }
            });
            
            document.getElementById('k-c1').innerText = kpC; document.getElementById('k-c2').innerText = krC; document.getElementById('k-c3').innerText = koC;
            
            let totTxt = S.totalHist ? ` | Total Histórico: ${S.totalHist}` : '';
            document.getElementById('pg-info').innerText = `Página ${S.page}${totTxt}`;
            
            document.getElementById('bp').disabled=S.page===1; document.getElementById('bn').disabled=S.data.length<25;
            if(document.getElementById('chk-all')) document.getElementById('chk-all').checked = false;
            
        } catch(e) { console.error("Render crash:", e); }
    }

    // SCROLL A TOP AL MOVERSE DE PAGINA
    function mv(d){ 
        S.page+=d; 
        let m = document.querySelector('main');
        if(m) m.scrollTo({top: 0, behavior: 'smooth'});
        load(); 
    }
    
    function switchTab(idx) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); let btn = document.getElementById('tb-'+idx); if(btn) btn.classList.add('active'); document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active')); document.getElementById('tab-'+idx).classList.add('active'); }
    
    // VISUAL DE LECTURA BLOQUEADA CORREGIDA (SOLO OPACIDAD)
    function toggleReadOnly() { 
        let icon = document.getElementById('btn-lock');
        let isLocked = icon.classList.contains('fa-lock'); 
        
        icon.className = isLocked ? 'fas fa-lock-open' : 'fas fa-lock'; 
        icon.parentElement.style.color = isLocked ? 'var(--text-sec)' : 'var(--st-err)'; 
        
        document.querySelectorAll('.m-body-form .inp, .chip-btn').forEach(el => { 
            el.disabled = !isLocked; 
            if(!isLocked) {
                el.style.opacity = '0.5';
                el.style.pointerEvents = 'none';
            } else {
                el.style.opacity = '1';
                el.style.pointerEvents = 'auto';
            }
        }); 
        document.getElementById('btn-s').style.display = isLocked ? 'flex' : 'none'; 
        showToast(isLocked ? "Edición habilitada" : "Modo Seguro Activo"); 
    }

    function updateColorDot(val) { let v = (val||'').toLowerCase(); let c = 'transparent'; if(v.includes('rojo')) c = '#ff1744'; else if(v.includes('azul')) c = '#2979ff'; else if(v.includes('blanco')) c = '#ffffff'; else if(v.includes('negro')) c = '#000000'; else if(v.includes('gris')||v.includes('plata')) c = '#9e9e9e'; else if(v.includes('verde')) c = '#00e676'; let dot=document.getElementById('c-dot'); if(dot) dot.style.background = c; }

    function form(d=null){
        try {
            let isEd=!!d; document.getElementById('f-ttl').innerText=isEd?'Editar Folio':'Nuevo Folio';
            let fId = isEd ? String(d[d.length-1]) : ''; document.getElementById('f-id').value = fId;
            
            let bp = document.getElementById('btn-print'); if(bp) bp.style.display=isEd?'flex':'none'; 
            let bw = document.getElementById('btn-warr'); if(bw) bw.style.display=isEd?'flex':'none';
            
            switchTab(1); if(typeof clearSignature==='function') clearSignature(); 
            let iconL = document.getElementById('btn-lock'); if(iconL && iconL.classList.contains('fa-lock')) toggleReadOnly();
            
            let fill = (id, cat) => { let el=document.getElementById(id); if(!el)return; let opts = S.lists.filter(x=>x.cat===cat).map(x=>`<option value="${x.val}">${x.val}</option>`).join(''); el.innerHTML = opts || '<option>Sin opciones</option>'; };
            fill('i_sede','SEDE'); fill('i_tec','TECNICO');

            if(isEd) { 
                MAP.forEach((id,i)=>{ let el=document.getElementById(id); if(!el)return; let v=d[i]; if(i===0&&v&&v.includes('T'))v=v.split('T')[0]; el.value=v||''; }); 
                let icol = document.getElementById('i_col'); if(icol) updateColorDot(icol.value); 
                updateTimerUI(fId); 
                let idia = document.getElementById('i_dia'); let dcount = document.getElementById('dia-count');
                if(idia && dcount) dcount.innerText = (idia.value.length || 0) + '/300';
            } else { 
                let draftStr = localStorage.getItem('jmautogas_draft');
                let parsed = null;
                if(draftStr) { try{parsed=JSON.parse(draftStr);}catch(e){} }
                
                if(parsed) { MAP.forEach(id => { let el=document.getElementById(id); if(el) el.value = parsed[id] || ''; }); } 
                else { MAP.forEach(id => { let el=document.getElementById(id); if(el) el.value = ''; }); let fec=document.getElementById('i_fec'); if(fec) fec.valueAsDate=new Date(); } 
                updateColorDot(''); let dcount = document.getElementById('dia-count'); if(dcount) dcount.innerText = '0/300'; updateTimerUI('new'); 
            }
            
            let anoVal = document.getElementById('i_ano')?.value;
            let alertOld = document.getElementById('alert-old-car');
            if(alertOld) alertOld.style.display = (anoVal && parseInt(anoVal) < 2010) ? 'flex' : 'none';

            let cp = document.getElementById('cam-preview'); if(cp) cp.style.display='none'; 
            document.getElementById('m-form').style.display='flex';
        } catch(e) {
            console.error("Form error:", e);
            showToast("Hubo un error al abrir el formulario.");
        }
    }

    let draftTimer;
    function doSaveDraft() { let fid=document.getElementById('f-id'); if(fid && fid.value !== '') return; let ind = document.getElementById('save-ind'); if(ind) ind.classList.add('show'); clearTimeout(draftTimer); draftTimer = setTimeout(() => { let draft = {}; MAP.forEach(id => { let el=document.getElementById(id); if(el) draft[id] = el.value; }); localStorage.setItem('jmautogas_draft', JSON.stringify(draft)); if(ind) setTimeout(()=>ind.classList.remove('show'), 2000); }, 1000); }
    function formatPat(i) { let v = i.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase(); if(v.length>2 && v.length<=4)v=v.slice(0,2)+'-'+v.slice(2); else if(v.length>4)v=v.slice(0,2)+'-'+v.slice(2,4)+'-'+v.slice(4,6); i.value=v; }
    function formatRut(i) { let v = i.value.replace(/[^0-9kK]/g, '').toUpperCase(); if(v.length>1)v=v.slice(0,-1)+'-'+v.slice(-1); if(v.length>5)v=v.slice(0,-5)+'.'+v.slice(-5); if(v.length>9)v=v.slice(0,-9)+'.'+v.slice(-9); i.value=v; }
    function toTitleCase(i) { i.value = i.value.replace(/\w\S*/g, txt => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()); doSaveDraft(); }
    function guessYear() { let el=document.getElementById('i_pat'); if(!el)return; let p = el.value.replace('-',''); if(p.length !== 6) return showToast("Patente inválida"); let L = p.charAt(0); let y = 2000; if(L==='B'||L==='C') y=2008; else if(L==='D'||L==='F') y=2010; else if(L==='G'||L==='H') y=2014; else if(L==='J'||L==='K') y=2017; else if(L==='L'||L==='P') y=2019; else if(L==='R'||L==='S') y=2021; else if(L==='T'||L==='V') y=2023; else if(L==='W'||L==='X') y=2025; let ay=document.getElementById('i_ano'); if(ay) ay.value = y; showToast("Año estimado: "+y); doSaveDraft(); }
    
    function addChipWithDate(id, t) { let e = document.getElementById(id); if(!e)return; let c = e.value.trim(); let dateStr = new Date().toLocaleDateString('es-CL',{month:'short',day:'numeric'}); let entry = `${t} (${dateStr})`; e.value = c ? c+'\n'+entry : entry; let dc=document.getElementById('dia-count'); if(dc) dc.innerText = e.value.length + '/300'; doSaveDraft(); showToast("Estado actualizado"); }
    function addChip(id, t) { let e = document.getElementById(id); if(!e)return; let c = e.value.trim(); e.value = c ? c+'\n'+t : t; let dc=document.getElementById('dia-count'); if(dc) dc.innerText = e.value.length + '/300'; doSaveDraft(); showToast("Agregado al detalle"); }
    function sendWspTpl(msg) { let c=document.getElementById('i_cel'); if(!c||!c.value) return showToast("Falta el celular"); let cCel = c.value.toString().replace(/\s+/g,''); cCel = cCel.startsWith('+') ? cCel : '+569' + cCel.slice(-8); let cl=document.getElementById('i_cli'); window.open(`https://wa.me/${cCel.replace('+','')}?text=${encodeURIComponent('Hola '+(cl?cl.value:'')+', JM Autogas informa: '+msg)}`, '_blank'); }

    let tInterval;
    function updateTimerUI(id) { clearInterval(tInterval); let st = localStorage.getItem('tt_start_'+id); let btn = document.getElementById('btn-tt'); if(!btn)return; if(st) { btn.innerHTML = '<i class="fas fa-pause"></i>'; btn.style.color = '#ff1744'; btn.style.borderColor = '#ff1744'; tInterval = setInterval(()=>drawTime(id), 1000); } else { btn.innerHTML = '<i class="fas fa-play" style="margin-left:3px"></i>'; btn.style.color = 'var(--primary)'; btn.style.borderColor = 'var(--primary)'; drawTime(id); } }
    function drawTime(id) { let acc = parseInt(localStorage.getItem('tt_acc_'+id) || 0); let st = localStorage.getItem('tt_start_'+id); if(st) acc += Math.floor((Date.now() - parseInt(st))/1000); let h = String(Math.floor(acc/3600)).padStart(2,'0'), m = String(Math.floor((acc%3600)/60)).padStart(2,'0'), s = String(acc%60).padStart(2,'0'); let td=document.getElementById('tt-disp'); if(td) td.innerText = `${h}:${m}:${s}`; }
    function toggleTimer() { let f=document.getElementById('f-id'); let id = f?f.value||'new':'new'; let st = localStorage.getItem('tt_start_'+id); if(st) { let acc = parseInt(localStorage.getItem('tt_acc_'+id) || 0) + Math.floor((Date.now() - parseInt(st))/1000); localStorage.setItem('tt_acc_'+id, acc); localStorage.removeItem('tt_start_'+id); } else { localStorage.setItem('tt_start_'+id, Date.now()); } updateTimerUI(id); }

    function handleCam(inp) { if(inp.files && inp.files[0]) { let reader = new FileReader(); reader.onload = function(e) { let cp=document.getElementById('cam-preview'); if(cp){cp.src = e.target.result; cp.style.display = 'block';} }; reader.readAsDataURL(inp.files[0]); } }

    let canvas = document.getElementById('sig-pad'), ctx; 
    if(canvas) ctx = canvas.getContext('2d');
    let drawing = false;
    function getPos(c, e) { let r = c.getBoundingClientRect(); return { x: (e.clientX || e.touches[0].clientX) - r.left, y: (e.clientY || e.touches[0].clientY) - r.top }; }
    function startDraw(e) { if(!ctx)return; drawing = true; let p = getPos(canvas, e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); }
    function draw(e) { if(!drawing || !ctx) return; let p = getPos(canvas, e); ctx.lineTo(p.x, p.y); ctx.strokeStyle = document.body.classList.contains('light-mode')?'#000':'#fff'; ctx.lineWidth = 2; ctx.stroke(); e.preventDefault(); }
    function stopDraw() { drawing = false; }
    if(canvas) { canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDraw); canvas.addEventListener('mouseout', stopDraw); canvas.addEventListener('touchstart', startDraw, {passive:false}); canvas.addEventListener('touchmove', draw, {passive:false}); canvas.addEventListener('touchend', stopDraw); }
    function clearSignature() { if(canvas&&ctx) ctx.clearRect(0, 0, canvas.width, canvas.height); } setTimeout(() => { if(canvas){canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;} }, 1000);

    let recognizing = false, recognition;
    function toggleDictation(id) { if (!('webkitSpeechRecognition' in window)) return showToast("Micrófono no soportado."); let btn = document.getElementById('btn-mic'), inp = document.getElementById(id); if(!inp)return; if (recognizing) { recognition.stop(); return; } recognition = new webkitSpeechRecognition(); recognition.lang = 'es-CL'; recognition.onstart = () => { recognizing = true; if(btn)btn.classList.add('recording'); }; recognition.onresult = (e) => { inp.value += (inp.value ? ' ' : '') + e.results[0][0].transcript; let dc=document.getElementById('dia-count'); if(dc) dc.innerText = inp.value.length + '/300'; doSaveDraft(); }; recognition.onend = () => { recognizing = false; if(btn)btn.classList.remove('recording'); }; recognition.start(); }
    function toggleSearchDictation() { if (!('webkitSpeechRecognition' in window)) return showToast("Micrófono no soportado."); let btn = document.getElementById('btn-search-mic'), inp = document.getElementById('q-inp'); if(!inp)return; if (recognizing) { recognition.stop(); return; } recognition = new webkitSpeechRecognition(); recognition.lang = 'es-CL'; recognition.onstart = () => { recognizing = true; if(btn)btn.style.color = '#ff1744'; }; recognition.onresult = (e) => { inp.value = e.results[0][0].transcript; doSearch(inp.value, true); }; recognition.onend = () => { recognizing = false; if(btn)btn.style.color = 'var(--primary)'; }; recognition.start(); }

    // --- GUARDADO PROTEGIDO ---
    async function save(){
        let iFec = document.getElementById('i_fec'), iPat = document.getElementById('i_pat');
        if(!iFec || !iPat || !iFec.value || !iPat.value) {
            if(iFec && !iFec.value) { iFec.style.borderColor = 'var(--st-err)'; setTimeout(()=>iFec.style.borderColor='var(--border)', 2000); }
            if(iPat && !iPat.value) { iPat.style.borderColor = 'var(--st-err)'; setTimeout(()=>iPat.style.borderColor='var(--border)', 2000); }
            return showToast("Falta Fecha o Patente");
        }
        
        let b=document.getElementById('btn-s'); if(b) {b.disabled=true; b.innerHTML='<i class="fas fa-spinner fa-spin"></i> GUARDANDO...';}
        
        try {
            let fid = document.getElementById('f-id'); let id = fid?fid.value:''; 
            let p=new URLSearchParams();
            p.append('sheetName',(S.cat==='TALLER'?'Folios ':'ABASTIBLE ')+S.year); p.append('action',id?'UPDATE':'CREATE'); if(id)p.append('rowId',id);
            
            MAP.forEach((mid,i)=>{ 
                let el=document.getElementById(mid); 
                let k=['ly','sede','ficha','cliente','rut','celular','comuna','marca','modelo','patente','color','km','fabricacion','coord','diag','colab','mat']; 
                p.append(k[i], el?el.value.toUpperCase():''); 
            });
            
            let res = await apiCall({}, p); 
            if(res) {
                localStorage.removeItem('jmautogas_draft'); closeM('m-form'); load(); 
                let idia = document.getElementById('i_dia');
                let isDone = idia && idia.value.toLowerCase().includes('entregado');
                showToast(isDone ? "🎉 ¡Folio Entregado!" : "Registro Guardado");
            }
        } catch(e) { 
            console.error(e);
            showToast("Error de conexión. Chequea el botón de Sincronización."); 
        } finally { 
            if(b) {b.disabled=false; b.innerHTML='<i class="fas fa-save"></i> GUARDAR REGISTRO';} 
        }
    }

    // ELIMINAR MASIVO CON CONFIRMACION
    let deleteTimers = {};
    function confirmDelete(id) {
        if(!S.user || (S.user.perms !== 'ALL' && !S.user.perms.includes('DEL'))) return showToast("Sin permisos para eliminar.");
        document.querySelectorAll(`input.row-chk[value="${id}"]`).forEach(el => { let row = el.closest('.animate-row'); if(row) row.style.display = 'none'; });
        showToast("Eliminando en 5s...", id);
        deleteTimers[id] = setTimeout(async () => { try { await apiCall({}, new URLSearchParams({sheetName:(S.cat==='TALLER'?'Folios ':'ABASTIBLE ')+S.year, action:'DELETE', rowId:id})); load(); } catch(e){} delete deleteTimers[id]; }, 5000);
    }
    function cancelUndo(id, toastEl) { if(deleteTimers[id]) { clearTimeout(deleteTimers[id]); delete deleteTimers[id]; } toastEl.remove(); showToast("Cancelado"); load(); }

    async function deleteSelected() {
        let sel = Array.from(document.querySelectorAll('.row-chk:checked')).map(c => c.value);
        if(sel.length === 0) return;
        
        if(!S.user || (S.user.perms !== 'ALL' && !S.user.perms.includes('DEL'))) return showToast("Sin permisos para eliminar.");

        let confirmacion = confirm(`⚠️ ADVERTENCIA CRÍTICA ⚠️\n\nEstás a punto de ELIMINAR PERMANENTEMENTE ${sel.length} registro(s).\nEsta acción NO se puede deshacer.\n\n¿Estás absolutamente seguro de continuar?`);
        if(!confirmacion) return;

        ld(true); st('fetch');
        try {
            for(let id of sel) {
                await apiCall({}, new URLSearchParams({sheetName:(S.cat==='TALLER'?'Folios ':'ABASTIBLE ')+S.year, action:'DELETE', rowId:id}));
            }
            showToast(`✅ ${sel.length} registros eliminados.`);
            let chkAll = document.getElementById('chk-all'); if(chkAll) chkAll.checked = false;
            document.getElementById('btn-batch').style.display = 'none';
            document.getElementById('btn-batch-del').style.display = 'none';
            load();
        } catch(e) {
            showToast("Error al eliminar algunos registros.");
            ld(false);
        }
    }

    function toggleAllChk(chk) { document.querySelectorAll('.row-chk').forEach(c => c.checked = chk.checked); let bb=document.getElementById('btn-batch'); if(bb) bb.style.display = chk.checked ? 'block' : 'none'; let bd=document.getElementById('btn-batch-del'); if(bd) bd.style.display = chk.checked ? 'block' : 'none'; }
    document.addEventListener('change', (e) => { if(e.target.classList.contains('row-chk')) { let any = document.querySelector('.row-chk:checked'); let bb=document.getElementById('btn-batch'); if(bb) bb.style.display = any ? 'block' : 'none'; let bd=document.getElementById('btn-batch-del'); if(bd) bd.style.display = any ? 'block' : 'none'; } });
    
    function exportSelected() { let sel = Array.from(document.querySelectorAll('.row-chk:checked')).map(c => c.value); if(sel.length === 0) return; let fd = S.data.filter(r => sel.includes(String(r[r.length-1]))); exportCSVRaw(fd); }
    function exportToCSV() { let fd = S.data; if(S.sedeFilter !== 'Todas') fd = fd.filter(r => r[1] && r[1].toUpperCase() === S.sedeFilter.toUpperCase()); exportCSVRaw(fd); }
    function exportCSVRaw(dataArr) { let csv = "Fecha,Sede,Ficha,Cliente,RUT,Celular,Comuna,Marca,Modelo,Patente,Color,KM,Año,Coord,Diagnostico,Tecnico,Materiales\n"; dataArr.forEach(r => { let row = r.slice(0, 17).map(c => `"${(c||'').toString().replace(/"/g, '""')}"`).join(','); csv += row + "\n"; }); let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); let link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Reporte_${new Date().getTime()}.csv`; link.click(); }
    
    // --- IMPRESION DE TABLA PDF CORREGIDA ---
    function exportPDFTable() { 
        let area = document.getElementById('print-area'); if(!area)return; 
        let html = `<div class="pr-head"><h2>REPORTE DE FLOTA - JM AUTOGAS</h2><p>Sede: ${S.sedeFilter} | Año: ${S.year}</p></div>
        <table style="width:100%; border-collapse:collapse; font-size:0.8rem; margin-bottom:20px;">
            <tr style="background:#eee;">
                <th style="padding:6px; border:1px solid #000;">Fecha</th>
                <th style="padding:6px; border:1px solid #000;">Ficha</th>
                <th style="padding:6px; border:1px solid #000;">Cliente</th>
                <th style="padding:6px; border:1px solid #000;">Patente</th>
                <th style="padding:6px; border:1px solid #000;">Vehículo</th>
                <th style="padding:6px; border:1px solid #000;">Diagnóstico</th>
            </tr>`; 
        let fd = S.data; if(S.sedeFilter !== 'Todas') fd = fd.filter(r => r[1] && r[1].toUpperCase() === S.sedeFilter.toUpperCase()); 
        fd.forEach(r => { 
            let d=r[0]?r[0].split('T')[0]:'-'; 
            html += `<tr>
                <td style="padding:6px; border:1px solid #000;">${d}</td>
                <td style="padding:6px; border:1px solid #000;">${r[2]||'-'}</td>
                <td style="padding:6px; border:1px solid #000;">${r[3]||'-'}</td>
                <td style="padding:6px; border:1px solid #000;">${r[9]||'-'}</td>
                <td style="padding:6px; border:1px solid #000;">${r[7]||''} ${r[8]||''}</td>
                <td style="padding:6px; border:1px solid #000;">${r[14]||'-'}</td>
            </tr>`; 
        }); 
        html += `</table>`; area.innerHTML = html; window.print(); 
    }
    
    function printOT() { let sigData = canvas?canvas.toDataURL():''; let area = document.getElementById('print-area'); if(!area)return; let iFic=document.getElementById('i_fic'), iSede=document.getElementById('i_sede'), iFec=document.getElementById('i_fec'), iCli=document.getElementById('i_cli'), iMar=document.getElementById('i_mar'), iMod=document.getElementById('i_mod'), iDia=document.getElementById('i_dia'); area.innerHTML = `<div class="pr-head"><h1 style="margin:0">ORDEN DE TRABAJO - JM AUTOGAS</h1><div style="font-size:0.8rem; margin-top:5px">Ficha: <b>${iFic?iFic.value||'-':'-'}</b> | Sede: ${iSede?iSede.value:'-'} | Fecha: ${iFec?iFec.value:'-'}</div></div><div class="pr-grid"><div class="pr-box"><div class="pr-lbl">Cliente</div><div class="pr-val">${iCli?iCli.value||'-':'-'}</div></div><div class="pr-box"><div class="pr-lbl">Vehículo</div><div class="pr-val">${iMar?iMar.value:''} ${iMod?iMod.value:''}</div></div></div><div class="pr-box" style="margin-bottom:10px; min-height:80px"><div class="pr-lbl">Diagnóstico</div><div class="pr-val" style="font-weight:normal; margin-top:5px">${iDia?iDia.value||'-':'-'}</div></div><div class="pr-sign"><img src="${sigData}" style="${(ctx&&ctx.getImageData(0,0,canvas.width,canvas.height).data.some(c=>c!==0)) ? '':'display:none'}">Firma Cliente</div>`; window.print(); }
    function printGarantia() { let area = document.getElementById('print-area'); if(!area)return; let iSede=document.getElementById('i_sede'), iCli=document.getElementById('i_cli'), iMar=document.getElementById('i_mar'), iMod=document.getElementById('i_mod'), iPat=document.getElementById('i_pat'), iMat=document.getElementById('i_mat'), iFec=document.getElementById('i_fec'), iTec=document.getElementById('i_tec'); area.innerHTML = `<div class="pr-head"><h1 style="margin:0">CERTIFICADO DE GARANTÍA GLP</h1><div style="font-size:0.8rem; margin-top:5px">JM AUTOGAS | Sede: ${iSede?iSede.value:'-'}</div></div><div class="pr-grid"><div class="pr-box"><div class="pr-lbl">Propietario</div><div class="pr-val">${iCli?iCli.value||'-':'-'}</div></div><div class="pr-box"><div class="pr-lbl">Vehículo</div><div class="pr-val">${iMar?iMar.value:''} ${iMod?iMod.value:''} Patente: ${iPat?iPat.value:''}</div></div></div><div class="pr-warr"><h3>CONDICIONES DE GARANTÍA</h3><p>1. El sistema de conversión a GLP instalado cuenta con garantía legal sobre los componentes de la marca <b>${iMat?iMat.value||'__________':''}</b>.</p><p>2. Esta garantía es válida solo si se realizan las mantenciones preventivas cada 10.000 KM en nuestra red de talleres JM Autogas.</p><p>3. Fecha de Instalación: <b>${iFec?iFec.value:'-'}</b>. Técnico: <b>${iTec?iTec.value:'-'}</b>.</p></div><div class="pr-sign">Timbre y Firma Taller</div>`; window.print(); }

    function openDash() { let fd = S.data; if(S.sedeFilter !== 'Todas') fd = fd.filter(r => r[1] && r[1].toUpperCase() === S.sedeFilter.toUpperCase()); let tecs = {}; let kmTotal = 0; let entregados = 0; fd.forEach(r => { let t = r[15]; if(t) tecs[t] = (tecs[t]||0)+1; kmTotal += parseInt(r[11]) || 0; if(r[14] && r[14].toLowerCase().includes('entregado')) entregados++; }); let total = fd.length; let efectividad = total > 0 ? Math.round((entregados/total)*100) : 0; let html = ` <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px"> <div style="background:var(--bg-input); padding:20px; border-radius:16px; text-align:center; border:1px solid var(--border); box-shadow:inset 0 2px 5px rgba(0,0,0,0.1)"> <div style="font-size:2.5rem; font-weight:800; color:var(--primary)">${total}</div><div style="font-size:0.8rem; color:var(--text-sec); font-weight:700">AUTOS VISTA</div> </div> <div style="background:var(--bg-input); padding:20px; border-radius:16px; text-align:center; border:1px solid ${efectividad > 50 ? 'var(--primary)' : 'var(--st-fetch)'}; box-shadow:inset 0 2px 5px rgba(0,0,0,0.1)"> <div style="font-size:2.5rem; font-weight:800; color:${efectividad > 50 ? 'var(--primary)' : 'var(--st-fetch)'}">${efectividad}%</div><div style="font-size:0.8rem; color:var(--text-sec); font-weight:700">EFECTIVIDAD</div> </div> </div> <div style="font-size:0.9rem; color:var(--text-main); margin-bottom:25px; text-align:center; background:var(--bg-input); padding:12px; border-radius:12px; border:1px solid var(--border)">KM Flota Total: <b style="color:var(--primary); font-family:monospace; font-size:1.1rem">${kmTotal.toLocaleString('es-CL')} km</b></div> <div style="font-size:0.85rem; font-weight:800; color:var(--text-sec); text-transform:uppercase; border-bottom:2px solid var(--border); padding-bottom:8px">Rendimiento Técnicos</div> `; Object.keys(tecs).sort((a,b)=>tecs[b]-tecs[a]).slice(0,5).forEach(t => { let pct = Math.round((tecs[t] / total) * 100); html += `<div class="stat-row" style="margin-top:15px; font-weight:600"><span>${t}</span><span>${tecs[t]} (${pct}%)</span></div><div class="bar-wrap" style="height:10px"><div class="bar-fill" style="width:0%; box-shadow:0 0 10px var(--primary-dim)" data-w="${pct}%"></div></div>`; }); let db=document.getElementById('dash-body'); if(db) db.innerHTML = html; let md=document.getElementById('m-dash'); if(md) md.style.display = 'flex'; setTimeout(() => { document.querySelectorAll('.bar-fill').forEach(b => b.style.width = b.getAttribute('data-w')); }, 100); }
    
    function openCalc() { let mc=document.getElementById('m-calc'); if(mc) mc.style.display='flex'; calcAhorro(); }
    function calcAhorro() { let cKm=document.getElementById('calc_km'), cRend=document.getElementById('calc_rend'), cVal=document.getElementById('calc_val'); let km = cKm?parseFloat(cKm.value)||0:0; let rend = cRend?parseFloat(cRend.value)||1:1; let val = cVal?parseFloat(cVal.value)||0:0; let litrosMensuales = km / rend; let ahorro = (litrosMensuales * 1350) - (litrosMensuales * 750); let cRes=document.getElementById('calc_res'); if(cRes) cRes.innerText = '$' + Math.max(0, ahorro).toLocaleString('es-CL'); let cRoi=document.getElementById('calc_roi'); if(cRoi) { if(ahorro > 0 && val > 0) { let meses = (val / ahorro).toFixed(1); cRoi.innerText = `¡Recuperas la inversión en ${meses} meses!`; } else cRoi.innerText = ''; } }

    function exportBackupJSON() { let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(S.data)); let downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `JM_Autogas_Backup_${new Date().toISOString().split('T')[0]}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); }
    function openCfg(){ let cl=document.getElementById('cfg-list'); if(cl) cl.innerHTML=S.lists.map(x=>`<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border); font-size:0.95rem; font-weight:500"><span><b>${x.cat}</b>: ${x.val}</span><i class="fas fa-trash" style="color:var(--st-err);cursor:pointer;opacity:0.7" onclick="delCfg(${x.id})"></i></div>`).join(''); let mc=document.getElementById('m-cfg'); if(mc) mc.style.display='flex'; }
    async function addCfg(){ let c=document.getElementById('c-cat'), v=document.getElementById('c-val'); if(!c||!v||!v.value)return; await apiCall({},new URLSearchParams({type:'config',action:'ADD',cat:c.value,val:v.value})); location.reload(); }
    async function delCfg(id){ if(!confirm("Eliminar?"))return; await apiCall({},new URLSearchParams({type:'config',action:'DEL',rowId:id})); location.reload(); }
    function openAdm(){ let ul=document.getElementById('usr-list'); if(ul) ul.innerHTML=S.users.map(u=>`<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border); font-size:0.95rem"><div><b style="color:var(--primary)">${u.user}</b> <small style="color:var(--text-sec); font-weight:600">[${u.perms}]</small></div>${u.user!=='Jimmy'?`<i class="fas fa-trash" style="color:var(--st-err);cursor:pointer;opacity:0.7" onclick="delUsr(${u.id})"></i>`:''}</div>`).join(''); let mu=document.getElementById('m-usr'); if(mu) mu.style.display='flex'; }
    async function addUsr(){ let u=document.getElementById('u-new'), p=document.getElementById('p-new'), adm=document.getElementById('adm-chk'); if(!u||!p||!u.value||!p.value)return; let perm=(adm&&adm.checked)?'ALL':'ADD,EDIT'; await apiCall({},new URLSearchParams({type:'users',action:'CREATE',u_user:u.value,u_pass:p.value,u_perms:perm})); location.reload(); }
    async function delUsr(id){ if(confirm("Eliminar usuario?")){ await apiCall({},new URLSearchParams({type:'users',action:'DELETE',rowId:id})); location.reload(); }}
</script>
</body>
</html>
